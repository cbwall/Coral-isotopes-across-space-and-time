---
title: "Symbiont ecology and its influence on the physiology and isotopic composition of a reef coral across space and time"
author: "CB Wall cbwall@hawaii.edu"
date: "9/19/2018"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---
```{r setup chunk, setup, warning=FALSE, message=FALSE, fig.align='center'}
require("knitr")
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

library(ggplot2)
library(broom.mixed)
library(broom)
library(tidyverse)
library(tidymodels)
library(plyr)
library(dplyr)
library(plotrix)
library(lubridate)
library(effects)
library(RCurl)
library(chron)
library(lubridate)
library(lme4)
library(emmeans)
library(multcomp)
library(devtools)
library(logihist)
library(popbio)
library(car)
library(lmerTest)
library(cowplot)
library(sjPlot)
library(sjmisc)
library(RgoogleMaps)
library(SDMTools)
library(rgdal)
library(maps)
library(png)
library(ecodist)
library(gridExtra)
```
## Project background
  
*Montipora capitata* was sampled at four reef locations in Kāne‘ohe Bay, O‘ahu, spanning a latitudinal (north-south) gradient of oceanic input and seawater residence and nearshore proximity (east-west)  
    
We measured changes in total biomass (ash-free dry weight), symbiont densiteis, photopigments (total chlorophylls (*a+c~2~*)), and stable isotopes (δ^13^C, δ^15^N) of the coral host, its endosymbionts *Symbiodinium*, and the coral skeleton.  

**Site map**
```{r Mapsetup, results="hide", warning=FALSE, message=FALSE}
# attach map GPS data
HI<-readOGR("data/coast_n83.shp", "coast_n83") # in meters
HI <- spTransform(HI, CRS("+proj=longlat +datum=NAD83"))

sites<-read.csv("data/environmental/Reefs_lat_long.csv", header=TRUE, na.string=NA)
```

```{r Map fig, results="hide", message="hide", warning="hide", fig.height=4.6, fig.width=5, fig.align = 'center', fig.cap="**Figure 1a.** *Study site locations in Kāne‘ohe Bay on the windward side of the island of O'ahu, Hawai'i*"}
# Make figure and export

###############

par(mar=c(1,1,1,1), pty="sq")
plot(HI, xlim=c(-157.86, -157.75), ylim=c(21.42, 21.5), lwd=1, col="gray87")

# adding tick marks and axis lat-long
axis(side=1, at=seq(-157.9, -157.70, 0.05), line=0, tck=0.02, labels=FALSE) # bottom
text(y=21.409, x=seq(-157.9, -157.70, 0.05), labels=seq(-157.9, -157.70, 0.05), cex=0.4)

axis(side=3, at=seq(-157.9, -157.70, 0.05), line=0, tck=0.02, labels=FALSE) # top

axis(side=2, at=seq(21.35, 21.55, 0.05), line=0, tck=0.02, labels=FALSE) # right
text(x=-157.857, y=seq(21.35, 21.55, 0.05), labels=seq(21.35, 21.55, 0.05),cex=0.4)

axis(side=4, at=seq(21.35, 21.55, 0.05), line=0, tck=0.02, labels=FALSE) # left

## add points to map, needs to be 'longitude-latitude formatted'
points(sites[,c(3,2)], pch=21, cex=1.3, col="black", bg="salmon")
text(sites[,c(3,2)], labels=c("SE\npatch reef", "SW\nfringe reef", "NE\npatch reef", "NW\nfringe reef"), pos=c(3,3,1,3), cex=0.5)

par(new=T, mar=c(15,15,1,1))
plot(HI, xlim=c(-158.27, -157.6), ylim=c(21.25, 21.72), lwd=0.4, col="gray", bg="white")  # Oahu
rect(-157.87, 21.39, -157.71, 21.53, lwd=0.8)
box()

##### save the figure and export to directory? ####
dev.copy(pdf, "figures/environmental/KBaymap.pdf", height=4.6, width=5)
dev.off

```

<center>
![](figures/M capitata_KBay_Wall.png){ width=60%} </center>
**Figure** *Montipora capitata* in Kāne'ohe Bay, O'ahu, Hawai'i. PC: C. Wall  

  

## Environmental

### Sea level correction  
Corals were collected across in summer and winter 2016 across several different days with each period. To correct for differences in the depth of coral colonies we used NOAA tide data to correct all depth measurements to Mean Sea Level (MSL). This approach was done in [Innis et al. 2018](https://link.springer.com/article/10.1007/s00338-018-1667-0) on a larger collection of the coral samples--which have been subset in the current study.

```{r sea level correction, fig.align='center', fig.dim=c(6,4.5), fig.cap="**Figure** *The differences in the depth where corals were collected in the field (x-axis) relative to the difference in the corrected depth (y-axis) using Mean Sea Level at the time of collection. Tidal correction from NOAA tide data.*"}
#########################
# Sea level correction
#########################
rm(list=ls())

#### attach data files
data<-read.csv("data/mastersheet_PanKBAY.csv") # master file
qPCR.Innis<-read.csv("data/PanKBay_summer_qPCR.csv") # qPCR from summer (Innis et al. 2018)

JuneTide=read.csv("data/environmental/sea level/Station_1612480_tide_ht_20160601-20160630.csv")
JulyTide=read.csv("data/environmental/sea level/Station_1612480_tide_ht_20160701-20160731.csv")
AugustTide=read.csv("data/environmental/sea level/Station_1612480_tide_ht_20160801-20160831.csv")
DecemberTide=read.csv("data/environmental/sea level/Station_1612480_tide_ht_20161201-20161222.csv")

Tide<-rbind(JuneTide, JulyTide, AugustTide, DecemberTide) # all MSL in meters

Tide$Time <- as.POSIXct(Tide$TimeUTC, format="%Y-%m-%d %H:%M:%S", tz="UTC")
attributes(Tide$Time)$tzone <- "Pacific/Honolulu"
# use attr(as.POSIXlt(Tide$Time),"tzone") to confirm in PST

Tide<-Tide[, c(-5:-8)] #remove unnecessary columns

data$date.time<- as.POSIXct(paste(as.character(data$Date), as.character(data$Time.of.collection)),
                 format="%m/%d/%y %H:%M", tz="Pacific/Honolulu") # make sure time in HST for master

data$Time.r<-round_date(data$date.time,unit="6 minutes")
Tide$Time.r <- Tide$Time
data<-merge(data, Tide, by="Time.r", all.x=T)
data$newDepth <- data$Depth..m-data$TideHT # new depth in METERS

sum.data<- data[(data$Season=="summer"),]; sum.depth.dif<- sum.data$newDepth-sum.data$Depth..m
win.data<- data[(data$Season=="winter"),]; win.depth.dif<- win.data$newDepth-win.data$Depth..m

#### make a plot of differences
# * note that plot works in Knit and alone in code chunk but isn't running if you "run all"*

plot(sum.depth.dif~sum.data$Depth..m, col="pink4", pch=21, bg="plum", cex.axis=0.8, cex.lab=0.8, ylim=c(-0.3, 0.3), xlim=c(0,10),
     xlab="Field depth observation (m)", 
     ylab="Corrected depth difference (m)")
abline(h=0, lty=2, col="gray")

par(new=T)
plot(win.depth.dif~win.data$Depth..m, col="deepskyblue4", pch=21, bg="deepskyblue1", 
     ylim=c(-0.3, 0.3), xlim=c(0,10), xaxt="n", yaxt="n", xlab="", ylab="")
abline(h=0, lty=2, col="gray")
legend("topright", c("Summer", "Winter"), pch=c(21,21), pt.bg=c("plum", "deepskyblue1"), col=c("pink4", "deepskyblue4"), cex=0.9, y.intersp = 1, x.intersp = 0.6, bty="n", inset=c(0, 0))
```
  
### Light parameters  
  
This figure shows the daily integrated light (DLI mol photon m^-2^ d^-1^) at long-term light loggers at 2m depth near the locations where corals were collected in northern and southern sectors of Kāne'ohe Bay near shore (east) further off shore (west). 

```{r DLI across time, results='hide', fig.cap="**Figure** *DLI at the four reef areas from summer to winter 2016 at 2m depths. Data at 2m was recorded from loggers*", eval=FALSE}
# DLI 2m all sites

##### all DLI for graphs
files <- list.files(path="data/environmental/temp and light/Jun_DecPAR/all DLI", pattern = "csv$", full.names = T)
tables <- lapply(files, read.csv, header = TRUE)
DLI<-do.call(rbind, tables)
DLI=DLI[-1] # remove junk column
DLI$Date<-as.Date(DLI$Date) # fix date
DLI<-DLI[order(DLI$Date),] # order by Date

# make a date sequence for entire study
all.date<-as.data.frame(seq(as.Date("2016-06-10"), as.Date("2017-01-12"), "days"))
colnames(all.date)="Date"

# merge the DLI data and the date sequence to make a complete df through time
DLI.3site<-merge(all.date, DLI, by="Date", all.x=T)
R10<-read.csv("data/environmental/temp and light/Jun_DecPAR/all DLI/Reef 10/DLI.Rf102016.csv")
R10<-R10[-1]; R10$Date<-as.Date(R10$Date)

DLI.4site<-merge(DLI.3site, R10, by="Date", all.x=T)
DLI.4site$month <- months(as.Date(DLI.4site$Date)) # makes a month column
DLI.4site<-DLI.4site[, c(1,6, 2:5)]

# write.csv(DLI.4site, "data/environmental/temp and light/Jun_DecPAR/All.DLI.csv")

##### Figure
All.DLI<-DLI.4site
reefcols=c("mediumseagreen", "dodgerblue", "salmon", "orchid")
par(mar=c(2,3.6,1,1.3), mgp=c(2,0.5,0))
layout(matrix(c(1,2,3,4), 2,2, byrow=TRUE))

plot(Rf44.mid.DLI~Date, type="l", All.DLI, ylab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), ylim=c(0, 30), xaxt="n", xlab="Time", col=reefcols[1])
legend("topright", lty=1, col=reefcols[1], legend="Northwest", lwd=1.5, bty="n", cex=0.8, 
       x.intersp = 0.3, inset=c(0.02, -0.02))
axis.Date(1, at=seq(min(All.DLI$Date), max(All.DLI$Date), by="2 mo"), format="%b '%y")

plot(Rf42.mid.DLI~Date, type="l", All.DLI, ylab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), ylim=c(0, 30), xaxt="n", xlab="Time", col=reefcols[2])
legend("topright", lty=1, col=reefcols[2], legend="Northeast", lwd=1.5, bty="n", cex=0.8, 
       x.intersp = 0.3, inset=c(0.02, -0.02))
axis.Date(1, at=seq(min(All.DLI$Date), max(All.DLI$Date), by="2 mo"), format="%b '%y")

plot(Rf10.mid.DLI~Date, type="l", All.DLI, ylab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1, ")", sep=""))), ylim=c(0, 30), xaxt="n", xlab="Time", col=reefcols[3])
legend("topright", lty=1, col=reefcols[3], legend="Southwest", lwd=1.5, bty="n", cex=0.8, 
       x.intersp = 0.3, inset=c(0.02, -0.02))
axis.Date(1, at=seq(min(All.DLI$Date), max(All.DLI$Date), by="2 mo"), format="%b '%y")

plot(HIMB.mid.DLI~Date, type="l", All.DLI, ylab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1, ")", sep=""))), ylim=c(0, 30), xaxt="n", xlab="Time", col=reefcols[4])
legend("topright", lty=1, col=reefcols[4], legend="Southeast", lwd=1.5, bty="n", cex=0.8, 
       x.intersp = 0.3, inset=c(0.02, -0.02))
axis.Date(1, at=seq(min(All.DLI$Date), max(All.DLI$Date), by="2 mo"), format="%b '%y")

dev.copy(pdf, "figures/environmental/All.DLI.pdf", width=6.5, height=4)
dev.off()
```
  

```{r DLI model, fig.dim=c(7,3), fig.show='hold', fig.align='center', fig.cap="**Figure** DLI model output", eval=FALSE}
# Model results testing differences in DLI at 2 m depth at all sites.
mod.light<-DLI.4site
Rf44DLI.mod<-mod.light[1:3]; Rf44DLI.mod$Location<-"Northwest"; 
    colnames(Rf44DLI.mod)<-c("Date", "month", "DLI", "Location")
Rf42DLI.mod<-mod.light[,c(1:2,4)]; Rf42DLI.mod$Location<-"Northeast"; 
    colnames(Rf42DLI.mod)<-c("Date", "month", "DLI", "Location")
HIMBDLI.mod<-mod.light[,c(1:2,5)]; HIMBDLI.mod$Location<-"Southeast"; 
    colnames(HIMBDLI.mod)<-c("Date", "month", "DLI", "Location")
Rf10DLI.mod<-mod.light[,c(1:2,6)]; Rf10DLI.mod$Location<-"Southwest"; 
    colnames(Rf10DLI.mod)<-c("Date", "month", "DLI", "Location")

All.DLI.mod<-rbind(Rf44DLI.mod, Rf42DLI.mod, HIMBDLI.mod, Rf10DLI.mod)
All.DLI.mod$Location<-as.factor(All.DLI.mod$Location)
All.DLI.mod$month<-as.factor(All.DLI.mod$month)
All.DLI.mod$Season<-ifelse(All.DLI.mod$month== "June" | 
                             All.DLI.mod$month== "July" |
                                All.DLI.mod$month== "August" |
                                  All.DLI.mod$month== "September", "dry season", "wet season")
All.DLI.mod$Season<-as.factor(All.DLI.mod$Season)

mod<-lmer(DLI~Location*Season + (1|Date), data=All.DLI.mod); anova(mod, type=2)
plot(allEffects(mod))
posthoc<-emmeans(mod, ~Location|Season)
CLD(posthoc, Letters=letters)

posthoc<-emmeans(mod, ~Season)
CLD(posthoc, Letters=letters)
```

#### PAR and DLI at 3 depths  
With Depth as a factor (<1m, 2m, 8m), we can produce a continuous graph of light (PAR or DLI) at 2m and use model intercepts to predict the light at the shallow and deep zones (ca. <1m and 8m, respectfully). Here, the model is $lm(log.PAR$ ~ $Depth.factor)$. 
```{r light as a factor figure, include=FALSE, results='hide', fig.show='hide'}

####################################################
### Light attenuation  October deployment ##########
####################################################


# using October deployment at 3 depths

df<-read.csv("data/environmental/temp and light/Field.allPAR.Oct2016.csv")
df<-df[ , -which(names(df) %in% c("X","Rf44.shallow", "Rf44.mid"))] # remove R44 w/o 3 levels
df$timestamp<-as.POSIXct(df$timestamp)
df[df<=1] <- NA # remove low values to get day only

Oct.PAR<-df
colnames(Oct.PAR)[2:7]<-"PAR" # change all light columns to read "PAR" this is for rbind later

Rf42.shall<-Oct.PAR[1:2] #only time and PAR
Rf42.shall$Site<-as.factor("Rf42") # make site level
Rf42.shall$Depth<-3*0.3048 # logger at 3 ft, convert to --> meters
Rf42.mid<-Oct.PAR[, c(1,3)]; Rf42.mid$Site<-as.factor("Rf42"); Rf42.mid$Depth<-8*0.3048 # logger at 8 ft 
Rf42.deep<-Oct.PAR[, c(1,4)]; Rf42.deep$Site<-as.factor("Rf42"); Rf42.deep$Depth<-27*0.3048 # logger at 27 ft

HIMB.shall<-Oct.PAR[, c(1,5)]; HIMB.shall$Site<-as.factor("HIMB"); HIMB.shall$Depth<-1*0.3048 # logger at 1 ft
HIMB.mid<-Oct.PAR[, c(1,6)]; HIMB.mid$Site<-as.factor("HIMB"); HIMB.mid$Depth<-6*0.3048 # logger at 6 ft
HIMB.deep<-Oct.PAR[, c(1,7)]; HIMB.deep$Site<-as.factor("HIMB"); HIMB.deep$Depth<-25*0.3048 # logger at 25 ft

PAR.df<-rbind(Rf42.shall, Rf42.mid, Rf42.deep, HIMB.shall, HIMB.mid, HIMB.deep)

# Break up into each reef
#####
PAR.Rf42<-PAR.df[(PAR.df$Site=="Rf42"),] # just Rf42
PAR.Rf42$Depth<-as.factor(PAR.Rf42$Depth) # depth as factor
PAR.Rf42$Depth <- factor(PAR.Rf42$Depth, levels = c("2.4384", "0.9144", "8.2296"))
PAR.Rf42$log.PAR<-log(PAR.Rf42$PAR)

mod<-lm(log.PAR~Depth, data=PAR.Rf42, na.action=na.exclude) # Rf42 dataframe with Depth as a factor
summary(mod)$coefficients # coefficients
Rf42.coeffs<-c(coef(mod)["(Intercept)"], coef(mod)[2], coef(mod)[3])

shal<-Rf42.coeffs[2]; mid<-Rf42.coeffs[1]; deep<-Rf42.coeffs[3]

####
####
# make new dataframes for Sites
Rf42.df<-df[1:4] 

####
# making some log data
Rf42.df$log.shal<-log(Rf42.df$Rf42.shallow)
Rf42.df$log.mid<-log(Rf42.df$Rf42.mid)
Rf42.df$log.deep<-log(Rf42.df$Rf42.deep)

# making some log data using coefficients
Rf42.df$coef.shal<-Rf42.df$log.mid + shal
Rf42.df$coef.mid<-Rf42.df$log.mid
Rf42.df$coef.deep<-Rf42.df$log.mid + deep

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf42.df$log.shal, x=Rf42.df$timestamp, type="l", col="dodgerblue", 
     main="Reef 42/NE logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="log(PAR)", xlab="", ylim=c(0,8))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$log.mid, x=Rf42.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$log.deep, x=Rf42.df$timestamp, type="l", col="paleturquoise3"))

##### plot of modeled 1m and 8m using <1m model coeffs. 
plot(y=Rf42.df$coef.shal, x=Rf42.df$timestamp, type="l", col="dodgerblue", ylab="log(PAR)", 
     xlab="Date", ylim=c(0,8))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$coef.mid, x=Rf42.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$coef.deep, x=Rf42.df$timestamp, type="l", col="paleturquoise3"))
legend("top", lty=1, col=c("dodgerblue", "gray", "paleturquoise3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)


################################ 
########### HIMB ############### 
PAR.HIMB<-PAR.df[(PAR.df$Site=="HIMB"),] # just HIMB
PAR.HIMB$Depth<-as.factor(PAR.HIMB$Depth) # depth as factor
PAR.HIMB$Depth <- factor(PAR.HIMB$Depth, levels = c("1.8288", "0.3048", "7.62"))

mod<-lm(log(PAR)~Depth, data=PAR.HIMB, na.action=na.exclude) # HIMB dataframe with Depth as a factor
summary(mod)$coefficients # coefficients
HIMB.coeffs<-c(coef(mod)["(Intercept)"], coef(mod)[2], coef(mod)[3])
shal<-HIMB.coeffs[2]; mid<-HIMB.coeffs[1]; deep<-HIMB.coeffs[3]

####
####
# make new dataframes for Sites
HIMB.df<-df[, c(1,5:7)]; 
HIMB.df[HIMB.df<=1] <- NA # remove leftover values that remain low independently

####
# making some log data
HIMB.df$log.shal<-log(HIMB.df$HIMB.shallow)
HIMB.df$log.mid<-log(HIMB.df$HIMB.mid)
HIMB.df$log.deep<-log(HIMB.df$HIMB.deep)

# making some log data using coefficients
HIMB.df$coef.shal<-HIMB.df$log.mid + shal
HIMB.df$coef.mid<-HIMB.df$log.mid 
HIMB.df$coef.deep<-HIMB.df$log.mid + deep


##################
##### Figure #####

# plot log data
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=HIMB.df$log.shal, x=HIMB.df$timestamp, type="l", col="mediumorchid2", 
     main="HIMB/SE logger (top), 2m-coeff (bottom)", cex.main=0.7, ylab="log(PAR)", 
     xlab="", ylim=c(0,8))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$log.mid, x=HIMB.df$timestamp, type="l", col="gray"))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$log.deep, x=HIMB.df$timestamp, type="l", col="plum4"))

# plot of modeled 1m and 8m using <2m model coeffs. 
plot(y=HIMB.df$coef.shal, x=HIMB.df$timestamp, type="l", col="mediumorchid2", 
     cex.main=0.7, ylab="log(PAR)", xlab="", ylim=c(0,8))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$coef.mid, x=HIMB.df$timestamp, type="l", col="gray"))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$coef.deep, x=HIMB.df$timestamp, type="l", col="plum4"))
legend("top", lty=1, col=c("mediumorchid2", "gray", "plum4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)



####################################################
####################################################
### Light attenuation  November deployment #########
####################################################
####################################################

# using November deployment at 3 depths

df<-read.csv("data/environmental/temp and light/Field.allPAR.Nov2016.csv"); df<-df[-1]
df$timestamp<-as.POSIXct(df$timestamp)
df[df<=1] <- NA # remove low values to get day only

Nov.PAR<-df
colnames(Nov.PAR)[2:7]<-"PAR" # change all light columns to read "PAR" this is for rbind later

Rf44.shall<-Nov.PAR[1:2] #only time and PAR
Rf44.shall$Site<-as.factor("Rf44") # make site level
Rf44.shall$Depth<-1*0.3048 # logger at 1 ft, convert to --> meters
Rf44.mid<-Nov.PAR[, c(1,3)]; Rf44.mid$Site<-as.factor("Rf44"); Rf44.mid$Depth<-6*0.3048 # logger at 6 ft 
Rf44.deep<-Nov.PAR[, c(1,4)]; Rf44.deep$Site<-as.factor("Rf44"); Rf44.deep$Depth<-25*0.3048 # logger at 25 ft

Rf10.shall<-Nov.PAR[, c(1,5)]; Rf10.shall$Site<-as.factor("Rf10"); Rf10.shall$Depth<-2*0.3048 # logger at 2 ft
Rf10.mid<-Nov.PAR[, c(1,6)]; Rf10.mid$Site<-as.factor("Rf10"); Rf10.mid$Depth<-6*0.3048 # logger at 6 ft
Rf10.deep<-Nov.PAR[, c(1,7)]; Rf10.deep$Site<-as.factor("Rf10"); Rf10.deep$Depth<-26*0.3048 # logger at 26 ft

# bind together
PAR.df<-rbind(Rf44.shall, Rf44.mid, Rf44.deep, Rf10.shall, Rf10.mid, Rf10.deep)

# Break up into each reef
#####
PAR.Rf44<-PAR.df[(PAR.df$Site=="Rf44"),] # just Rf44
PAR.Rf44$Depth<-as.factor(PAR.Rf44$Depth) # depth as factor
PAR.Rf44$Depth <- factor(PAR.Rf44$Depth, levels = c("1.8288", "0.3048", "7.62"))
PAR.Rf44$log.PAR<-log(PAR.Rf44$PAR)

mod<-lm(log.PAR~Depth, data=PAR.Rf44, na.action=na.exclude) # R44 dataframe with Depth as a factor
summary(mod)$coefficients # coefficients
Rf44.coeffs<-c(coef(mod)["(Intercept)"], coef(mod)[2], coef(mod)[3])
shal<-Rf44.coeffs[2]; mid<-Rf44.coeffs[1]; deep<-Rf44.coeffs[3]

####
####
# make new dataframes for Sites
Rf44.df<-df[1:4] 

####
# making some log data
Rf44.df$log.shal<-log(Rf44.df$Rf44.shallow)
Rf44.df$log.mid<-log(Rf44.df$Rf44.mid)
Rf44.df$log.deep<-log(Rf44.df$Rf44.deep)

# making some log data using coefficients
Rf44.df$coef.shal<-Rf44.df$log.mid + shal
Rf44.df$coef.mid<-Rf44.df$log.mid
Rf44.df$coef.deep<-Rf44.df$log.mid + deep

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf44.df$log.shal, x=Rf44.df$timestamp, type="l", col="yellowgreen", 
     main="Reef 44/NW logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="log(PAR)", xlab="", ylim=c(0,8))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$log.mid, x=Rf44.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$log.deep, x=Rf44.df$timestamp, type="l", col="palegreen4"))

##### plot of modeled 2m and 8m using <1m model coeffs. 
plot(y=Rf44.df$coef.shal, x=Rf44.df$timestamp, type="l", col="yellowgreen", ylab="log(PAR)", 
     xlab="", ylim=c(0,8))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$coef.mid, x=Rf44.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$coef.deep, x=Rf44.df$timestamp, type="l", col="palegreen4"))
legend("top", lty=1, col=c("yellowgreen", "gray", "palegreen4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)



###################################
########### Reef 10 ############### 
PAR.Rf10<-PAR.df[(PAR.df$Site=="Rf10"),] # just Rf10
PAR.Rf10$Depth<-as.factor(PAR.Rf10$Depth) # depth as factor
PAR.Rf10$Depth <- factor(PAR.Rf10$Depth, levels = c("1.8288", "0.6096", "7.9248"))

mod<-lm(log(PAR)~Depth, data=PAR.Rf10, na.action=na.exclude) # Rf10 dataframe with Depth as a factor
summary(mod)$coefficients # coefficients
Rf10.coeffs<-c(coef(mod)["(Intercept)"], coef(mod)[2], coef(mod)[3])
shal<-Rf10.coeffs[2]; mid<-Rf10.coeffs[1]; deep<-Rf10.coeffs[3]

####
####
# make new dataframes for Sites
Rf10.df<-df[, c(1,5:7)]

####
# making some log data
Rf10.df$log.shal<-log(Rf10.df$Rf10.shallow)
Rf10.df$log.mid<-log(Rf10.df$Rf10.mid)
Rf10.df$log.deep<-log(Rf10.df$Rf10.deep)

# making some log data using coefficients
Rf10.df$coef.shal<-Rf10.df$log.mid + shal
Rf10.df$coef.mid<-Rf10.df$log.mid
Rf10.df$coef.deep<-Rf10.df$log.mid + deep

##################
##### Figure #####

# plot log data
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf10.df$log.shal, x=Rf10.df$timestamp, type="l", col="orangered", 
     main="Reef 10/SE logger (top), 2m-coeff (bottom)", cex.main=0.7, ylab="log(PAR)", 
     xlab="", ylim=c(0,8))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$log.mid, x=Rf10.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$log.deep, x=Rf10.df$timestamp, type="l", col="rosybrown2"))

# plot of modeled 2m and 8m using <1m model coeffs. 
plot(y=Rf10.df$coef.shal, x=Rf10.df$timestamp, type="l", col="orangered", 
     cex.main=0.7, ylab="log(PAR)", xlab="", ylim=c(0,8))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$coef.mid, x=Rf10.df$timestamp, type="l", col="gray"))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$coef.deep, x=Rf10.df$timestamp, type="l", col="rosybrown2"))
legend("top", lty=1, col=c("orangered", "gray", "rosybrown2"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.45), seg.len=1, cex=0.9, xpd=TRUE, horiz=TRUE)


########
# combine all coefficients
all.coefficients<-rbind(Rf42.coeffs, HIMB.coeffs, Rf44.coeffs, Rf10.coeffs)
write.csv(all.coefficients, "data/environmental/light coeffs_factor.csv")

###########

par(mfrow=c(4,3), mar=c(4,4,2,2))
d<-Rf42.df
plot(d$log.shal~d$coef.shal); abline(lm(d$log.shal~d$coef.shal), col="red")
plot(d$log.mid~d$coef.mid, main="Northwest"); abline(lm(d$log.mid~d$coef.mid), col="red")
plot(d$log.deep~d$coef.deep); abline(lm(d$log.deep~d$coef.deep), col="red")

d<-Rf44.df
plot(d$log.shal~d$coef.shal); abline(lm(d$log.shal~d$coef.shal), col="red")
plot(d$log.mid~d$coef.mid, main="Northeast"); abline(lm(d$log.mid~d$coef.mid), col="red")
plot(d$log.deep~d$coef.deep); abline(lm(d$log.deep~d$coef.deep), col="red")

d<-HIMB.df
plot(d$log.shal~d$coef.shal); abline(lm(d$log.shal~d$coef.shal), col="red")
plot(d$log.mid~d$coef.mid, main="Southeast"); abline(lm(d$log.mid~d$coef.mid), col="red")
plot(d$log.deep~d$coef.deep); abline(lm(d$log.deep~d$coef.deep), col="red")

d<-Rf10.df
plot(d$log.shal~d$coef.shal); abline(lm(d$log.shal~d$coef.shal), col="red")
plot(d$log.mid~d$coef.mid, main="Southwest"); abline(lm(d$log.mid~d$coef.mid), col="red")
plot(d$log.deep~d$coef.deep); abline(lm(d$log.deep~d$coef.deep), col="red")

#dev.copy(pdf, "figures/environmental/PAR_coef_ob.ex.factor.pdf", height=6, width=6)
#dev.off()

########### 


#########################
#########################
#########################

##### 
##### all PAR
files <- list.files(path="data/environmental/temp and light/Jun_DecPAR/all PAR", pattern = "csv$", full.names = T)
tables <- lapply(files, read.csv, header = TRUE)
All.PAR<-do.call(rbind, tables)
All.PAR=All.PAR[-1]
All.PAR$timestamp<-as.POSIXct(All.PAR$timestamp) # fix date

# make a date sequence for entire study
all.date.time<-as.data.frame(seq(
  from=as.POSIXct("2016-06-10 00:00:00", tz="HST"),
  to=as.POSIXct("2017-01-12 00:00:00", tz="HST"),
  by="15 min"))  
colnames(all.date.time)[1]<-"timestamp"

# merge the PAR data and the date sequence to make a complete df through time
PAR.3site<-merge(all.date.time, All.PAR, by="timestamp", all.x=T)
R10.par<-read.csv("data/environmental/temp and light/Jun_DecPAR/all PAR/Reef 10/Rf10.PAR.csv")
R10.par<-R10.par[-1]; R10.par$timestamp<-as.POSIXct(R10.par$timestamp)

PAR.4site<-merge(PAR.3site, R10.par, by="timestamp", all.x=T)
PAR.4site$month <- months(as.Date(PAR.4site$timestamp)) # makes a month column
PAR.4site<-PAR.4site[, c(1,6, 2:5)]

# determine monthly mean for PAR during deployments at depth
write.csv(PAR.4site, "data/environmental/temp and light/Jun_DecPAR/All.PAR.csv")


###########
###########
########### 
# read in all PAR data at 2m and model what the 1m and 8m data would look like
df<-PAR.4site # all the instantaneous light data
df[df<=1] <- NA

coeffs<-read.csv("data/environmental/light coeffs.csv") # modeled coefficients
colnames(coeffs)<-c("Site", "Intercept", "shal.coeff", "deep.coeff")

# log transform PAR data to determine light at depth, then reverse transform

## example calcs
# df$log.shal<-df$log.mid - mid.coeff
# df$log.mid<-df$log.mid
# df$log.deep<-df$log.mid - mid.coeff + deep.coeff

df$logRf42.mid<-log(df$Rf42.mid)
df$logRf42.shall<-log(df$Rf42.mid) + coeffs[1,3]
df$logRf42.deep<-log(df$Rf42.mid) + coeffs[1,4]

df$logHIMB.mid<-log(df$HIMB.mid)
df$logHIMB.shall<-log(df$HIMB.mid) + coeffs[2,3]
df$logHIMB.deep<-log(df$HIMB.mid) + coeffs[2,4]

df$logRf44.mid<-log(df$Rf44.mid)
df$logRf44.shall<-log(df$Rf44.mid) + coeffs[3,3]
df$logRf44.deep<-log(df$Rf44.mid) + coeffs[3,4]

df$logRf10.mid<-log(df$Rf10.mid)
df$logRf10.shall<-log(df$Rf10.mid) + coeffs[4,3]
df$logRf10.deep<-log(df$Rf10.mid) + coeffs[4,4]


df$bt.Rf42.mid<-1*exp(df$logRf42.mid)
df$bt.Rf42.shall<-1*exp(df$logRf42.shall)
df$bt.Rf42.deep<-1*exp(df$logRf42.deep)

df$bt.Rf44.mid<-1*exp(df$logRf44.mid)
df$bt.Rf44.shall<-1*exp(df$logRf44.shall)
df$bt.Rf44.deep<-1*exp(df$logRf44.deep)

df$bt.HIMB.mid<-1*exp(df$logHIMB.mid)
df$bt.HIMB.shall<-1*exp(df$logHIMB.shall)
df$bt.HIMB.deep<-1*exp(df$logHIMB.deep)

df$bt.Rf10.mid<-1*exp(df$logRf10.mid)
df$bt.Rf10.shall<-1*exp(df$logRf10.shall)
df$bt.Rf10.deep<-1*exp(df$logRf10.deep)


All.PAR.df<-df[, (names(df) %in% c("timestamp", "month", 
                                   "bt.Rf42.shall", "bt.Rf42.mid", "bt.Rf42.deep",
                                   "bt.Rf44.shall", "bt.Rf44.mid", "bt.Rf44.deep", 
                                   "bt.HIMB.shall", "bt.HIMB.mid", "bt.HIMB.deep",  
                                   "bt.Rf10.shall", "bt.Rf10.mid", "bt.Rf10.deep"))]

colnames(All.PAR.df)<-c("timestamp", "month", 
                        "Rf42.mid", "Rf42.shall", "Rf42.deep",
                        "Rf44.mid", "Rf44.shall", "Rf44.deep", 
                        "HIMB.mid", "HIMB.shall", "HIMB.deep",  
                        "Rf10.mid", "Rf10.shall", "Rf10.deep")
```

```{r figure PAR at 3 depths, results='hide', fig.cap="**Figure** *PAR at the four reef areas from summer to winter 2016 at three depths (<1m, 2m, 8m). Data at 2m was recorded from loggers; data at <1m and 8m were modeled using light attenuation calculations*"}
# Plot it!!
# Reef 44
par(mfrow=c(2,2), mar=c(4,5,2,2))

plot(y=All.PAR.df$Rf44.shall, x=All.PAR.df$timestamp, type="l", col="palegreen3", 
     cex.main=0.7, ylab=(expression(paste("PAR"~(mu*mol~photons~m^-2~s^-1), sep="")))
     , xlab="", main="Northwest", cex.main=1, ylim=c(0, 2400))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf44.mid, x=All.PAR.df$timestamp, type="l", col="gray"))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf44.deep, x=All.PAR.df$timestamp, type="l", col="palegreen4"))
legend("topright", lty=1, col=c("palegreen3", "gray", "palegreen4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.01), seg.len=1, cex=0.9, x.intersp=0.5, y.intersp=0.8)


# Plot it!!
# Reef 42
plot(y=All.PAR.df$Rf42.shall, x=All.PAR.df$timestamp, type="l", col="mediumturquoise", 
     cex.main=0.7, ylab=(expression(paste("PAR"~(mu*mol~photons~m^-2~s^-1), sep="")))
     , xlab="", main="Northeast", cex.main=1, ylim=c(0, 2400))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf42.mid, x=All.PAR.df$timestamp, type="l", col="gray"))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf42.deep, x=All.PAR.df$timestamp, type="l", col="dodgerblue2"))
legend("topright", lty=1, col=c("mediumturquoise", "gray", "dodgerblue2"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.01), seg.len=1, cex=0.9, x.intersp=0.5, y.intersp=0.8)

# Plot it!!
# Reef 10
plot(y=All.PAR.df$Rf10.shall, x=All.PAR.df$timestamp, type="l", col="orangered", 
     cex.main=0.7, ylab=(expression(paste("PAR"~(mu*mol~photons~m^-2~s^-1), sep="")))
     , xlab="Dates", main="Southwest", cex.main=1, ylim=c(0, 2400))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf10.mid, x=All.PAR.df$timestamp, type="l", col="gray"))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$Rf10.deep, x=All.PAR.df$timestamp, type="l", col="lightsalmon3"))
legend("topright", lty=1, col=c("orangered", "gray", "lightsalmon3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.01), seg.len=1, cex=0.9, x.intersp=0.5, y.intersp=0.8)

# Plot it!
# HIMB
plot(y=All.PAR.df$HIMB.shall, x=All.PAR.df$timestamp, type="l", col="mediumorchid2", 
     cex.main=0.7, ylab=(expression(paste("PAR"~(mu*mol~photons~m^-2~s^-1), sep="")))
     , xlab="Dates", main="Southeast", cex.main=1, ylim=c(0, 2400))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$HIMB.mid, x=All.PAR.df$timestamp, type="l", col="gray"))
par(new=T)
with(All.PAR.df, lines(y=All.PAR.df$HIMB.deep, x=All.PAR.df$timestamp, type="l", col="plum4"))
legend("topright", lty=1, col=c("mediumorchid2", "gray", "plum4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.01), seg.len=1, cex=0.9, x.intersp=0.5, y.intersp=0.8)

dev.copy(pdf, "figures/environmental/PAR.all depths.pdf", height=7, width=8)
dev.off()
```

```{r figure DLI at 3 depths, results='hide', fig.cap="**Figure** *DLI at the four reef areas from summer to winter 2016 at three depths (<1m, 2m, 8m). Data at 2m was recorded from loggers; data at <1m and 8m were modeled using light attenuation calculations*"}

#######
####### calculate DLI and compare
#######
df<-All.PAR.df
df$timestamp<-strptime(df$timestamp, format="%Y-%m-%d %H:%M:%S")
df$timestamp<-as.Date(df$timestamp, format="%Y-%m-%d") # change to DATE ONLY format to calulate range, means
df[is.na(df)] <- 0


df.split <- split(df, f=df$timestamp
                  < as.Date("2016-06-10", format="%Y-%m-%d")) # split df by date

df.dli<-aggregate(data.frame(Rf42.shall.DLI=df.split[[1]]$Rf42.shall*0.0864,
                             Rf42.mid.DLI=df.split[[1]]$Rf42.mid*0.0864,
                             Rf42.deep.DLI=df.split[[1]]$Rf42.deep*0.0864,
                             Rf44.shall.DLI=df.split[[1]]$Rf44.shall*0.0864,
                             Rf44.mid.DLI=df.split[[1]]$Rf44.mid*0.0864,
                             Rf44.deep.DLI=df.split[[1]]$Rf44.deep*0.0864,
                             HIMB.shall.DLI=df.split[[1]]$HIMB.shall*0.0864,
                             HIMB.mid.DLI=df.split[[1]]$HIMB.mid*0.0864,
                             HIMB.deep.DLI=df.split[[1]]$HIMB.deep*0.0864,
                             Rf10.shall.DLI=df.split[[1]]$Rf10.shall*0.0864,
                             Rf10.mid.DLI=df.split[[1]]$Rf10.mid*0.0864,
                             Rf10.deep.DLI=df.split[[1]]$Rf10.deep*0.0864),
                  by=list(Date=df.split[[1]]$timestamp), FUN=mean)


# make a date sequence for entire study
all.date.time<-as.data.frame(seq(
  from=as.POSIXct("2016-06-10", tz="HST"),
  to=as.POSIXct("2017-01-12", tz="HST"),
  by="1 d"))  
colnames(all.date.time)[1]<-"Date"
all.date.time$Date<-strptime(all.date.time$Date, format="%Y-%m-%d")
all.date.time$Date<-as.Date(all.date.time$Date, format="%Y-%m-%d")

df.dli<-merge(all.date.time, df.dli, by="Date", all.x=T)
df.dli[df.dli<=0] <- NA


#####################
# Plot it!!
# Reef 44
par(mfrow=c(2,2), mar=c(4,5,2,2))

plot(y=df.dli$Rf44.shall, x=df.dli$Date, type="h", col="palegreen3", 
     cex.main=0.7, ylab=(expression(paste("DLI"~(mol~photons~m^-2~d^-1), sep="")))
     , xlab="", main="Northwest", cex.main=1, ylim=c(0, 50))
par(new=T)
with(df.dli, lines(y=df.dli$Rf44.mid, x=df.dli$Date, type="h", col="gray"))
par(new=T)
with(df.dli, lines(y=df.dli$Rf44.deep, x=df.dli$Date, type="h", col="palegreen4"))
legend("topright", lty=1, col=c("palegreen3", "gray", "palegreen4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0.01, 0), seg.len=1, cex=0.9, x.intersp=0.2, y.intersp=1)


# Plot it!!
# Reef 42
plot(y=df.dli$Rf42.shall, x=df.dli$Date, type="h", col="mediumturquoise", 
     cex.main=0.7, ylab=(expression(paste("DLI"~(mol~photons~m^-2~d^-1), sep="")))
     , xlab="", main="Northeast", cex.main=1, ylim=c(0, 50))
par(new=T)
with(df.dli, lines(y=df.dli$Rf42.mid, x=df.dli$Date, type="h", col="gray"))
par(new=T)
with(df.dli, lines(y=df.dli$Rf42.deep, x=df.dli$Date, type="h", col="dodgerblue2"))
legend("topright", lty=1, col=c("mediumturquoise", "gray", "dodgerblue2"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0.01, 0), seg.len=1, cex=0.9, x.intersp=0.2, y.intersp=1)

# Plot it!!
# Reef 10
plot(y=df.dli$Rf10.shall, x=df.dli$Date, type="h", col="orangered", 
     cex.main=0.7, ylab=(expression(paste("DLI"~(mol~photons~m^-2~d^-1), sep="")))
     , xlab="Dates", main="Southwest", cex.main=1, ylim=c(0, 50))
par(new=T)
with(df.dli, lines(y=df.dli$Rf10.mid, x=df.dli$Date, type="h", col="gray"))
par(new=T)
with(df.dli, lines(y=df.dli$Rf10.deep, x=df.dli$Date, type="h", col="lightsalmon3"))
legend("topright", lty=1, col=c("orangered", "gray", "lightsalmon3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0.01, 0), seg.len=1, cex=0.9, x.intersp=0.2, y.intersp=1)

# Plot it!
# HIMB
plot(y=df.dli$HIMB.shall, x=df.dli$Date, type="h", col="mediumorchid2", 
     cex.main=0.7, ylab=(expression(paste("DLI"~(mol~photons~m^-2~d^-1), sep="")))
     , xlab="Dates", main="Southeast", cex.main=1, ylim=c(0, 50))
par(new=T)
with(df.dli, lines(y=df.dli$HIMB.mid, x=df.dli$Date, type="h", col="gray"))
par(new=T)
with(df.dli, lines(y=df.dli$HIMB.deep, x=df.dli$Date, type="h", col="plum4"))
legend("topright", lty=1, col=c("mediumorchid2", "gray", "plum4"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0.01, 0), seg.len=1, cex=0.9, x.intersp=0.2, y.intersp=1)

dev.copy(pdf, "figures/environmental/DLIcalc.all depths.pdf", height=7, width=8)
dev.off()
```

```{r bar plot of DLI a depths, fig.dim=c(4,4), fig.cap="**Figure** Average (+/- SE) Daily Light Integral (DLI) for four reef locations at three depths pooled from June - January. DLI estimated from light attenuation coefficents using depth as a fixed effect against baseline loggers at 2 m depth"}

DLI.summary<-read.csv("data/environmental/temp and light/Jun_DecPAR/DLI.3depth.summary.csv")
DLI.summary$Location<-factor(DLI.summary$Location, levels=c("NW", "NE", "SW", "SE"))
DLI.summary$Depth.zone<-factor(DLI.summary$Depth.zone, levels=c("shallow", "mid", "deep"))

#####
# figure formatting script
Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        axis.line=element_blank(),
        legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect("transparent", colour=NA),
        legend.text=element_text(size=10),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, colour = "black", size=0.8),
        aspect.ratio=1, 
        axis.ticks = element_line(colour = 'black', size = 0.4),
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10)) +
theme(legend.spacing.x = unit(0.2, 'cm'),
      legend.key.size = unit(0.4, "cm"))

pd <- position_dodge(0.7) #offset for error bars and columns
#####

Location.label<-c("NW", "NE", "SW", "SE")
Depth.label<-c("<1m", "2m", "8m")
plot_colors2<-c("lightskyblue", "dodgerblue", "deepskyblue4")
plot_stat<-c("slategray", "dodgerblue2", "steelblue1", "slategray", "dodgerblue2", "steelblue1",
             "slategray", "dodgerblue2", "steelblue1","slategray", "dodgerblue2", "steelblue1")

# DLI by site and depth
Fig.DLI<-ggplot(DLI.summary, aes(x=Location, y=DLI.mean, fill=Depth.zone)) +
  geom_bar(stat="identity", col=plot_stat, position = pd, width=0.7, size=0.3) +
  geom_errorbar(aes(ymin=DLI.mean-DLI.se, ymax=DLI.mean+DLI.se),
                size=0.4, width=0, position=pd, col=plot_stat) +
  xlab("Locations") +
  ylab(expression(paste("DLI", ~(mol~photons~m^-2~d^-1), sep=""))) +
  scale_x_discrete(labels=Location.label) +
  scale_y_continuous(expand=c(0,0), limits=c(0, 35)) +
  scale_fill_manual(values=alpha(c(plot_colors2), 0.6), 
                    labels=Depth.label)+ Fig.formatting; Fig.DLI

ggsave(file="figures/environmental/DLI.bar.pdf", height=4, width=4)
```

#### Attenuation and Light-at-Depth
A periodic deployment of loggers (October and November) at ca. <1m and ca. 7m were used to model the relationship between 2m light and light at other depths.  
  
Using the logger data, the difference in light at 1 and 7m was calculated relative to 2m (i.e, PAR baseline (2m) - PAR other), then the difference in depth at 1 and 7m was calculated realtive to logger depth i.e, depth logger other - depth logger (2m baseline). A no-intercept model was used to fit difference in log(DLI) and depth (i.e, log(delta-DLI) and delta-depth) with depth as a *continous/numeric variable* to determine *kd*: $lm(delta.log.DLI$~$delta.Depth + 0)$.  
  
Site-specific kd values were used to generate a continuous variable of "light at depth". At each time period (summer or winter) the daily light integral was averaged over 3 months: *summer 2016 (June, July, August)* and *winter 2016 (November, December, January)*. Discrete monthly seasonal-mean DLI means was used to generate an estimate of light at depth for corals at each site, as this integrates the site and seasoanl variance.   
  
Light at Depth was calculated following Beer-Lambert: $Ez{_d} = Ez_{_0}e^{(-k_d *d)}$, where $d$ is depth, $k_d$ is the attenuation coefficient for each site, $Ez{_d}$ is light at depth $d$ and $Ez{_0}$ is measured light. Calculations were relative to light at 2m depth (i.e., $Ez_{_0}$ was the light at 2m depth) and $d$ was the difference between coral depth relative to depth of the logger (i.e., 2m). 
  
```{r site-specifc kd, results='hide', fig.show='hide', echo=FALSE}

df<-read.csv("data/environmental/temp and light/DLI.Oct2016.csv")
df<-df[ , -which(names(df) %in% c("X","Rf44.shall.DLI", "Rf44.mid.DLI"))] # remove R44 w/o 3 levels
df$Date<-as.Date(df$Date)

Oct.DLI<-df
colnames(Oct.DLI)[2:7]<-"DLI" # change all light columns to read "PAR" this is for rbind later


# Adding Depth of logger to dataframe
Rf42.shall<-Oct.DLI[1:2] #only time and PAR
Rf42.shall$Site<-as.factor("Rf42") # make site level
Rf42.shall$Depth<-3*0.3048 # logger at 3 ft, convert to --> meters
Rf42.mid<-Oct.DLI[, c(1,3)]; Rf42.mid$Site<-as.factor("Rf42"); Rf42.mid$Depth<-8*0.3048 # logger at 8 ft 
Rf42.deep<-Oct.DLI[, c(1,4)]; Rf42.deep$Site<-as.factor("Rf42"); Rf42.deep$Depth<-27*0.3048 # logger at 27 ft

HIMB.shall<-Oct.DLI[, c(1,5)]; HIMB.shall$Site<-as.factor("HIMB"); HIMB.shall$Depth<-1*0.3048 # logger at 1 ft
HIMB.mid<-Oct.DLI[, c(1,6)]; HIMB.mid$Site<-as.factor("HIMB"); HIMB.mid$Depth<-6*0.3048 # logger at 6 ft
HIMB.deep<-Oct.DLI[, c(1,7)]; HIMB.deep$Site<-as.factor("HIMB"); HIMB.deep$Depth<-25*0.3048 # logger at 25 ft

# bind together all the data in single dataframe with 4 columns: time, PAR, Site, Depth
DLI.df<-rbind(Rf42.shall, Rf42.mid, Rf42.deep, HIMB.shall, HIMB.mid, HIMB.deep)
DLI.df$log.DLI<-log(DLI.df$DLI) # log transform PAR data
DLI.df<-DLI.df[, c(1,3:4,2,5)]

####
# make new dataframes for Sites
Rf42.df<-df[1:4] 
Rf42.depths<-c(3*0.3048, 8*0.3048, 27*0.3048)

####
# Beer-Lambert Law:   Ez(d) = Ez(0)e^(-k_d *d)  
# where d is depth, k_d is the attenuation coefficient, Ez(d) is the light reaching depth d and Ez(0) is the incident light at the surface.

# with 2m as baseline:  E(depth) = E(2m)*e^(-k_d*(depth - 2m))
# making some log data
Rf42.df$log.shal<-log(Rf42.df$Rf42.shall.DLI)
Rf42.df$log.mid<-log(Rf42.df$Rf42.mid.DLI)
Rf42.df$log.deep<-log(Rf42.df$Rf42.deep.DLI)

Rf42.df$log.delta.mid.deep<-Rf42.df$log.mid-Rf42.df$log.deep # difference in 2m - 8m light
Rf42.df$log.delta.mid.shal<-Rf42.df$log.mid-Rf42.df$log.shal # difference in 2m - 1m light
Rf42.df$dm.depth<-Rf42.depths[3]-Rf42.depths[2] # difference in depth 8m - 2m
Rf42.df$sm.depth<-Rf42.depths[1]-Rf42.depths[2] # difference in depth 1m - 2m
Rf42.df$mm.depth<-Rf42.depths[2]-Rf42.depths[2] # difference in depth 2m - 2m

new.df<-Rf42.df[8:11]; colnames(new.df)<-c("log.DLI.delta", "log.DLI.delta", "Depth.delta", "Depth.delta")
new.df1<-rbind(new.df[1], new.df[2]); new.df2<-rbind(new.df[3], new.df[4])
df.test<-cbind(new.df1, new.df2) # for both columns has delta PAR and depth

kd.mod<-lm(log.DLI.delta~Depth.delta+0, data=df.test, na.action=na.exclude) # Rf42 dataframe with Depth as a factor
kd<-coef(kd.mod)[1] # use KD here to calculate light at any depth

kd.R42<-kd ### save this

# example
par(mfrow=c(3,1))
Rf42.df$Rf42.expect<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$sm.depth)
plot(Rf42.df$Rf42.expect~Rf42.df$Rf42.shall.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="SHALLOW observed DLI")
abline(lm(Rf42.df$Rf42.expect~Rf42.df$Rf42.shall.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf42.df$Rf42.expect<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$mm.depth)
plot(Rf42.df$Rf42.expect~Rf42.df$Rf42.mid.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="MID DEPTH observed DLI")
abline(lm(Rf42.df$Rf42.expect~Rf42.df$Rf42.mid.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf42.df$Rf42.expect<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$dm.depth)
plot(Rf42.df$Rf42.expect~Rf42.df$Rf42.deep.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="DEEP observed DLI")
abline(lm(Rf42.df$Rf42.expect~Rf42.df$Rf42.deep.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.3)


# making some data
# notice that you need kd to be (+) here--or do absolute value of depth
Rf42.df$coef.shal<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$sm.depth)
Rf42.df$coef.mid<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$mm.depth)
Rf42.df$coef.deep<-Rf42.df$Rf42.mid.DLI*exp(-kd*Rf42.df$dm.depth)

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf42.df$Rf42.shall.DLI, x=Rf42.df$Date, type="l", col="dodgerblue", 
     main="Reef 42/NE logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="DLI", xlab="", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf42.df, lines(y=Rf42.df$Rf42.mid.DLI, x=Rf42.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$Rf42.deep.DLI, x=Rf42.df$Date, type="l", col="paleturquoise3", lwd=2))

##### plot of modeled 1m and 8m using <1m model coeffs. 
plot(y=Rf42.df$coef.shal, x=Rf42.df$Date, type="l", col="dodgerblue", ylab="log(PAR)", 
     xlab="Date", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf42.df, lines(y=Rf42.df$coef.mid, x=Rf42.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf42.df, lines(y=Rf42.df$coef.deep, x=Rf42.df$Date, type="l", col="paleturquoise3", lwd=2))
legend("top", lty=1, col=c("dodgerblue", "gray", "paleturquoise3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)

dev.copy(pdf, "figures/environmental/DLI_coef_Rf42.pdf", height=6, width=4)
dev.off()


####################################
###################################

############ HIMB ############
# make new dataframes for Sites
HIMB.df<-df[, c(1,5:7)] 
HIMB.depths<-c(1*0.3048, 6*0.3048, 25*0.3048)

####
# with 2m as baseline:  E(depth) = E(2m)*e^(-k_d*(depth - 2m))
# making some log data
HIMB.df$log.shal<-log(HIMB.df$HIMB.shall.DLI)
HIMB.df$log.mid<-log(HIMB.df$HIMB.mid.DLI)
HIMB.df$log.deep<-log(HIMB.df$HIMB.deep.DLI)

HIMB.df$log.delta.mid.deep<-HIMB.df$log.mid-HIMB.df$log.deep # difference in 2m - 8m light
HIMB.df$log.delta.mid.shal<-HIMB.df$log.mid-HIMB.df$log.shal # difference in 2m - 1m light
HIMB.df$dm.depth<-HIMB.depths[3]-HIMB.depths[2] # difference in depth 8m - 2m
HIMB.df$sm.depth<-HIMB.depths[1]-HIMB.depths[2] # difference in depth 1m - 2m
HIMB.df$mm.depth<-HIMB.depths[2]-HIMB.depths[2] # difference in depth 2m - 2m

new.df<-HIMB.df[8:11]; colnames(new.df)<-c("log.DLI.delta", "log.DLI.delta", "Depth.delta", "Depth.delta")
new.df1<-rbind(new.df[1], new.df[2]); new.df2<-rbind(new.df[3], new.df[4])
df.test<-cbind(new.df1, new.df2) # for both columns has delta PAR and depth

kd.mod<-lm(log.DLI.delta~Depth.delta+0, data=df.test, na.action=na.exclude) # HIMB dataframe with Depth as a factor
kd<-coef(kd.mod)[1] # use KD here to calculate light at any depth

kd.HIMB<-kd ### save this

# example
par(mfrow=c(3,1))
HIMB.df$HIMB.expect<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$sm.depth)
plot(HIMB.df$HIMB.expect~HIMB.df$HIMB.shall.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="SHALLOW observed DLI")
abline(lm(HIMB.df$HIMB.expect~HIMB.df$HIMB.shall.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

HIMB.df$HIMB.expect<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$mm.depth)
plot(HIMB.df$HIMB.expect~HIMB.df$HIMB.mid.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="MID DEPTH observed DLI")
abline(lm(HIMB.df$HIMB.expect~HIMB.df$HIMB.mid.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

HIMB.df$HIMB.expect<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$dm.depth)
plot(HIMB.df$HIMB.expect~HIMB.df$HIMB.deep.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="DEEP observed DLI")
abline(lm(HIMB.df$HIMB.expect~HIMB.df$HIMB.deep.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.3)


# making some data
# notice that you need kd to be (+) here--or do absolute value of depth
HIMB.df$coef.shal<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$sm.depth)
HIMB.df$coef.mid<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$mm.depth)
HIMB.df$coef.deep<-HIMB.df$HIMB.mid.DLI*exp(-kd*HIMB.df$dm.depth)

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=HIMB.df$HIMB.shall.DLI, x=HIMB.df$Date, type="l", col="dodgerblue", 
     main="HIMB/SE logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="DLI", xlab="", ylim=c(0,40), lwd=2)
par(new=T)
with(HIMB.df, lines(y=HIMB.df$HIMB.mid.DLI, x=HIMB.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$HIMB.deep.DLI, x=HIMB.df$Date, type="l", col="paleturquoise3", lwd=2))

##### plot of modeled 1m and 8m using <1m model coeffs. 
plot(y=HIMB.df$coef.shal, x=HIMB.df$Date, type="l", col="dodgerblue", ylab="log(PAR)", 
     xlab="Date", ylim=c(0,40), lwd=2)
par(new=T)
with(HIMB.df, lines(y=HIMB.df$coef.mid, x=HIMB.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(HIMB.df, lines(y=HIMB.df$coef.deep, x=HIMB.df$Date, type="l", col="paleturquoise3", lwd=2))
legend("top", lty=1, col=c("dodgerblue", "gray", "paleturquoise3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)

dev.copy(pdf, "figures/environmental/DLI_coef_HIMB.pdf", height=6, width=4)
dev.off()



####################################################
####################################################
### Light attenuation  November deployment #########
####################################################
####################################################

# using November deployment at 3 depths

df<-read.csv("data/environmental/temp and light/DLI.Nov2016.csv")
df<-df[ , -which(names(df) %in% "X")] # remove "X"
df$Date<-as.Date(df$Date)

Nov.DLI<-df
colnames(Nov.DLI)[2:7]<-"DLI" # change all light columns to read "PAR" this is for rbind later

# Adding Depth of logger to dataframe
Rf44.shall<-Nov.DLI[1:2] #only time and PAR
Rf44.shall$Site<-as.factor("Rf44") # make site level
Rf44.shall$Depth<-1*0.3048 # logger at 1 ft, convert to --> meters
Rf44.mid<-Nov.DLI[, c(1,3)]; Rf44.mid$Site<-as.factor("Rf44"); Rf44.mid$Depth<-6*0.3048 # logger at 6 ft 
Rf44.deep<-Nov.DLI[, c(1,4)]; Rf44.deep$Site<-as.factor("Rf44"); Rf44.deep$Depth<-25*0.3048 # logger at 25 ft

Rf10.shall<-Nov.DLI[, c(1,5)]; Rf10.shall$Site<-as.factor("Rf10"); Rf10.shall$Depth<-2*0.3048 # logger at 2 ft
Rf10.mid<-Nov.DLI[, c(1,6)]; Rf10.mid$Site<-as.factor("Rf10"); Rf10.mid$Depth<-6*0.3048 # logger at 6 ft
Rf10.deep<-Nov.DLI[, c(1,7)]; Rf10.deep$Site<-as.factor("Rf10"); Rf10.deep$Depth<-26*0.3048 # logger at 26 ft

# bind together all the data in single dataframe with 4 columns: time, PAR, Site, Depth
DLI.df<-rbind(Rf44.shall, Rf44.mid, Rf44.deep, Rf10.shall, Rf10.mid, Rf10.deep)
DLI.df$log.DLI<-log(DLI.df$DLI) # log transform PAR data
DLI.df<-DLI.df[, c(1,3:4,2,5)]

###############
###############

# make new dataframes for Sites
Rf44.df<-df[1:4] 
Rf44.depths<-c(1*0.3048, 6*0.3048, 25*0.3048)

####
# with 2m as baseline:  E(depth) = E(2m)*e^(-k_d*(depth - 2m))
# making some log data
Rf44.df$log.shal<-log(Rf44.df$Rf44.shall.DLI)
Rf44.df$log.mid<-log(Rf44.df$Rf44.mid.DLI)
Rf44.df$log.deep<-log(Rf44.df$Rf44.deep.DLI)

Rf44.df$log.delta.mid.deep<-Rf44.df$log.mid-Rf44.df$log.deep # difference in 2m - 8m light
Rf44.df$log.delta.mid.shal<-Rf44.df$log.mid-Rf44.df$log.shal # difference in 2m - 1m light
Rf44.df$dm.depth<-Rf44.depths[3]-Rf44.depths[2] # difference in depth 8m - 2m
Rf44.df$sm.depth<-Rf44.depths[1]-Rf44.depths[2] # difference in depth 1m - 2m
Rf44.df$mm.depth<-Rf44.depths[2]-Rf44.depths[2] # difference in depth 2m - 2m

new.df<-Rf44.df[8:11]; colnames(new.df)<-c("log.DLI.delta", "log.DLI.delta", "Depth.delta", "Depth.delta")
new.df1<-rbind(new.df[1], new.df[2]); new.df2<-rbind(new.df[3], new.df[4])
df.test<-cbind(new.df1, new.df2) # for both columns has delta PAR and depth

kd.mod<-lm(log.DLI.delta~Depth.delta+0, data=df.test, na.action=na.exclude) # Rf44 dataframe with Depth as a factor
kd<-coef(kd.mod)[1] # use KD here to calculate light at any depth

kd.R44<-kd ### save this

# example
par(mfrow=c(3,1))
Rf44.df$Rf44.expect<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$sm.depth)
plot(Rf44.df$Rf44.expect~Rf44.df$Rf44.shall.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="SHALLOW observed DLI")
abline(lm(Rf44.df$Rf44.expect~Rf44.df$Rf44.shall.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf44.df$Rf44.expect<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$mm.depth)
plot(Rf44.df$Rf44.expect~Rf44.df$Rf44.mid.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="MID DEPTH observed DLI")
abline(lm(Rf44.df$Rf44.expect~Rf44.df$Rf44.mid.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf44.df$Rf44.expect<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$dm.depth)
plot(Rf44.df$Rf44.expect~Rf44.df$Rf44.deep.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="DEEP observed DLI")
abline(lm(Rf44.df$Rf44.expect~Rf44.df$Rf44.deep.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.3)


# making some data
# notice that you need kd to be (+) here--or do absolute value of depth
Rf44.df$coef.shal<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$sm.depth)
Rf44.df$coef.mid<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$mm.depth)
Rf44.df$coef.deep<-Rf44.df$Rf44.mid.DLI*exp(-kd*Rf44.df$dm.depth)

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf44.df$Rf44.shall.DLI, x=Rf44.df$Date, type="l", col="dodgerblue", 
     main="Reef 44/NW logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="DLI", xlab="", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf44.df, lines(y=Rf44.df$Rf44.mid.DLI, x=Rf44.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$Rf44.deep.DLI, x=Rf44.df$Date, type="l", col="paleturquoise3", lwd=2))

##### plot of modeled 1m and 8m using <1m model coeffs. 
plot(y=Rf44.df$coef.shal, x=Rf44.df$Date, type="l", col="dodgerblue", ylab="log(PAR)", 
     xlab="Date", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf44.df, lines(y=Rf44.df$coef.mid, x=Rf44.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf44.df, lines(y=Rf44.df$coef.deep, x=Rf44.df$Date, type="l", col="paleturquoise3", lwd=2))
legend("top", lty=1, col=c("dodgerblue", "gray", "paleturquoise3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)

dev.copy(pdf, "figures/environmental/DLI_coef_Rf44.pdf", height=6, width=4)
dev.off()


################
################

## Reef 10 ############

# make new dataframes for Sites
Rf10.df<-df[, c(1,5:7)] 
Rf10.depths<-c(2*0.3048, 6*0.3048, 26*0.3048)

####
# with 2m as baseline:  E(depth) = E(2m)*e^(-k_d*(depth - 2m))
# making some log data
Rf10.df$log.shal<-log(Rf10.df$Rf10.shall.DLI)
Rf10.df$log.mid<-log(Rf10.df$Rf10.mid.DLI)
Rf10.df$log.deep<-log(Rf10.df$Rf10.deep.DLI)

Rf10.df$log.delta.mid.deep<-Rf10.df$log.mid-Rf10.df$log.deep # difference in 2m - 8m light
Rf10.df$log.delta.mid.shal<-Rf10.df$log.mid-Rf10.df$log.shal # difference in 2m - 1m light
Rf10.df$dm.depth<-Rf10.depths[3]-Rf10.depths[2] # difference in depth 8m - 2m
Rf10.df$sm.depth<-Rf10.depths[1]-Rf10.depths[2] # difference in depth 1m - 2m
Rf10.df$mm.depth<-Rf10.depths[2]-Rf10.depths[2] # difference in depth 2m - 2m

new.df<-Rf10.df[8:11]; colnames(new.df)<-c("log.DLI.delta", "log.DLI.delta", "Depth.delta", "Depth.delta")
new.df1<-rbind(new.df[1], new.df[2]); new.df2<-rbind(new.df[3], new.df[4])
df.test<-cbind(new.df1, new.df2) # for both columns has delta PAR and depth

kd.mod<-lm(log.DLI.delta~Depth.delta+0, data=df.test, na.action=na.exclude) # Rf10 dataframe with Depth as a factor
kd<-coef(kd.mod)[1] # use KD here to calculate light at any depth

kd.R10<-kd ### save this

# example
par(mfrow=c(3,1))
Rf10.df$Rf10.expect<-Rf10.df$Rf10.mid.DLI*exp(-(kd+0.3)*Rf10.df$sm.depth)
plot(Rf10.df$Rf10.expect~Rf10.df$Rf10.shall.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="SHALLOW observed DLI")
abline(lm(Rf10.df$Rf10.expect~Rf10.df$Rf10.shall.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf10.df$Rf10.expect<-Rf10.df$Rf10.mid.DLI*exp(-kd*Rf10.df$mm.depth)
plot(Rf10.df$Rf10.expect~Rf10.df$Rf10.mid.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="MID DEPTH observed DLI")
abline(lm(Rf10.df$Rf10.expect~Rf10.df$Rf10.mid.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.5)

Rf10.df$Rf10.expect<-Rf10.df$Rf10.mid.DLI*exp(-(kd-0.09)*Rf10.df$dm.depth)
plot(Rf10.df$Rf10.expect~Rf10.df$Rf10.deep.DLI, main="lm(log.DLI.delta~Depth.delta + 0)", 
     ylab="expected DLI", xlab="DEEP observed DLI")
abline(lm(Rf10.df$Rf10.expect~Rf10.df$Rf10.deep.DLI), col="red"); abline(0, 1, col="green")
legend("topleft", lty=1, col=c("red", "green"), legend=c("model", "1:1 line"), 
       lwd=1, bty="n", seg.len=1, cex=1.1, y.intersp=0.3)


# making some data
# notice that you need kd to be (+) here--or do absolute value of depth
Rf10.df$coef.shal<-Rf10.df$Rf10.mid.DLI*(exp)(-kd*Rf10.df$sm.depth)
Rf10.df$coef.mid<-Rf10.df$Rf10.mid.DLI*exp(-kd*Rf10.df$mm.depth)
Rf10.df$coef.deep<-Rf10.df$Rf10.mid.DLI*exp(-kd*Rf10.df$dm.depth)

##################
##### Figure #####
# how does data compare?

##### plot log data collected at each site
par(mfrow=c(2,1), mar=c(4,4,2,2))
plot(y=Rf10.df$Rf10.shall.DLI, x=Rf10.df$Date, type="l", col="dodgerblue", 
     main="Reef 10/SW logger (top), 2m-coeff (bottom)", cex.main=0.7, 
     ylab="DLI", xlab="", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf10.df, lines(y=Rf10.df$Rf10.mid.DLI, x=Rf10.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$Rf10.deep.DLI, x=Rf10.df$Date, type="l", col="paleturquoise3", lwd=2))

##### plot of modeled 1m and 8m using <1m model coeffs. 
plot(y=Rf10.df$coef.shal, x=Rf10.df$Date, type="l", col="dodgerblue", ylab="log(PAR)", 
     xlab="Date", ylim=c(0,40), lwd=2)
par(new=T)
with(Rf10.df, lines(y=Rf10.df$coef.mid, x=Rf10.df$Date, type="l", col="gray", lwd=2))
par(new=T)
with(Rf10.df, lines(y=Rf10.df$coef.deep, x=Rf10.df$Date, type="l", col="paleturquoise3", lwd=2))
legend("top", lty=1, col=c("dodgerblue", "gray", "paleturquoise3"), legend=c("<1m", "2m", "8m"), 
       lwd=2, bty="n", inset=c(0, -0.5), seg.len=1, cex=1.1, xpd=TRUE, horiz=TRUE)

dev.copy(pdf, "figures/environmental/DLI_coef_Rf10.pdf", height=6, width=4)
dev.off()

kd.all<-as.data.frame(c(kd.R42, kd.R44, kd.HIMB, kd.R10))
kd.all$Sites<-as.factor(c("Rf42", "Rf44", "HIMB", "Rf10")); kd.all<-kd.all[2:1]
colnames(kd.all)<-c("Site", "kd")

write.csv(kd.all, "data/environmental/kd.all.csv")

####
#### end
####
```

```{r light at depth, fig.dim=c(6,5), fig.align='center', fig.cap="**Figure** *Relationship between mean seasonal light availability (mean daily light integral) at depth of coral fragment collection*"}
########################## # LIGHT AT DEPTH
#############
###### 
# using new depth and the site-specific kd (light attenuation) determine approximate "light at depth" for each colony sample. 

######

### attach necessary files
logger.depths<-read.csv("data/environmental/temp and light/light.logger.depths.csv") # depths for loggers
kd.all<-read.csv("data/environmental/kd.all.csv") # kds for each site

# Seasonal DLI used for "period of collection" light levels
month.DLI<-read.csv("data/environmental/temp and light/Jun_DecPAR/All.DLI_long.csv")

# corals collected in June-July-August use summer time DLI for these months as indicator of average DLI
summer.DLI<-month.DLI[(month.DLI$Month=="June" | month.DLI$Month=="July" | month.DLI$Month=="August"),]
winter.DLI<-month.DLI[(month.DLI$Month=="November" | month.DLI$Month=="December" |month.DLI$Month=="January"),]

# summer mean and SE dataframe
sum.mean<-aggregate(DLI~Site, summer.DLI, mean)
sum.SE<-aggregate(DLI~Site, summer.DLI, std.error)
sum.light.df<-cbind(sum.mean, sum.SE[2])
colnames(sum.light.df)=c("Site", "mean.DLI", "se.DLI")
sum.light.df$Season<-as.factor("summer")

# winter mean and SE dataframe
wint.mean<-aggregate(DLI~Site, winter.DLI, mean)
wint.SE<-aggregate(DLI~Site, winter.DLI, std.error)
wint.light.df<-cbind(wint.mean, wint.SE[2])
colnames(wint.light.df)=c("Site", "mean.DLI", "se.DLI")
wint.light.df$Season<-as.factor("winter")

season.DLI<-rbind(sum.light.df[,c(4,1,2:3)], wint.light.df[,c(4,1,2:3)]) # compiled means for DLI at ~2m
season.DLI$Location<- as.factor(c("SE", "SW", "NE", "NW", "SE", "SW", "NE", "NW")); season.DLI<-season.DLI[,c(1,5,2:4)]

write.csv(season.DLI, "data/environmental/season.DLI.csv")
#######################################
### make new dataframe for calculations
df.light<- data[, c("Season", "Reef", "Location", "newDepth")]

# make a column of "depth differences" relative to where ~2m logger was deployed
df.light$depth.diff<-ifelse(df.light$Reef=="F1-R46", df.light$newDepth-1.8288,
                          ifelse(df.light$Reef=="F8-R10", df.light$newDepth-1.8288, 
                                 ifelse(df.light$Reef=="HIMB", df.light$newDepth-1.8288, 
                                        df.light$newDepth-2.4384))) # last statement for remaining site (Rf42)

# make a column for sample-specific light at depth (estimate) based on kd
# follow: #with 2m as baseline#  E(depth) = E(2m)*exp(-k_d*(depth - 2m))
# so that:     light at depth = DLI at mid.depth * exp (-kd *(delta shallow-deep in m))


df.light$Light<-ifelse(df.light$Reef=="HIMB" & df.light$Season=="summer", 
                          season.DLI$mean.DLI[1]*exp(-kd.all$kd[1]*df.light$depth.diff), # summer HIMB
                   ifelse(df.light$Reef=="F8-R10" & df.light$Season=="summer", 
                          season.DLI$mean.DLI[2]*exp(-kd.all$kd[2]*df.light$depth.diff), # summer R10
                   ifelse(df.light$Reef=="R42" & df.light$Season=="summer", 
                          season.DLI$mean.DLI[3]*exp(-kd.all$kd[3]*df.light$depth.diff), # summer R42
                   ifelse(df.light$Reef=="F1-R46" & df.light$Season=="summer", 
                                 season.DLI$mean.DLI[4]*exp(-kd.all$kd[4]*df.light$depth.diff), # summer R46
                          
                   ifelse(df.light$Reef=="HIMB" & df.light$Season=="winter", 
                          season.DLI$mean.DLI[5]*exp(-kd.all$kd[1]*df.light$depth.diff), # winter HIMB
                   ifelse(df.light$Reef=="F8-R10" & df.light$Season=="winter", 
                          season.DLI$mean.DLI[6]*exp(-kd.all$kd[2]*df.light$depth.diff), # winter R10
                   ifelse(df.light$Reef=="R42" & df.light$Season=="winter", 
                          season.DLI$mean.DLI[7]*exp(-kd.all$kd[3]*df.light$depth.diff), # winter R42
                          season.DLI$mean.DLI[8]*exp(-kd.all$kd[4]*df.light$depth.diff)) # winter R46
                            ))))))

###### plot of light x depth by season
df.light$Reef <- factor(df.light$Reef, levels = c("F1-R46", "R42", "F8-R10", "HIMB"))
df.light$Location <- factor(df.light$Location, levels=c("NW", "NE", "SW", "SE"))

plot.by.sites=ggplot(df.light, aes(Light)) + geom_density(aes(fill=Location), alpha=0.3, position = 'stack') + scale_x_continuous(limits=c(0, 40)) + ggtitle("Light at Depth by Seasons") 

plot.by.site=ggplot(df.light, aes(Light)) + geom_density(aes(fill=Season), alpha=0.3, position = 'stack') +
  scale_x_continuous(limits=c(0, 40)) + ggtitle("Light at Depth by Seasons") + facet_wrap(~Location, scales="free") + scale_fill_manual(values=c("darkorange1", "dodgerblue1"))

######
# can loop as a list
p=ggplot(df.light, aes(Light, fill=Season)) + geom_density(alpha=0.3, position = 'stack') + scale_x_continuous(limits=c(0, 40)) + ggtitle("Light at Depth by Seasons") 

plots=dlply(df.light, .(Location), function(x) p %+% x + facet_wrap(~Location))


###### plot of light x depth by season with exponential curve fitting
Sum<-df.light[(df.light$Season=="summer"),]
Win<-df.light[(df.light$Season=="winter"),]

plot(Light~newDepth, Sum, col="coral", pch=16, xlab="Depth (m)", ylab="DLI at coral", 
     ylim=c(0, 30), xlim=c(0, 10))
summod<-lm(log(Light)~newDepth, Sum)
curve(exp(coef(summod)["(Intercept)"]+coef(summod)["newDepth"]*x), add=TRUE, col="coral", lwd=2)
par(new=T)
plot(Light~newDepth, Win, col="lightblue2", pch=16, xaxt="n", yaxt="n", 
     xlab="", ylab="", ylim=c(0, 30), xlim=c(0, 10))
wintmod<-lm(log(Light)~newDepth, Win)
curve(exp(coef(wintmod)["(Intercept)"]+coef(wintmod)["newDepth"]*x), add=TRUE, col="lightblue2", lwd=2)
legend("topright", legend=c("summer", "winter"), col=c("coral", "lightblue2"), lty=1, lwd=1, pch=16, bty="n")
```
  
### Dissolved nutrients  
  
Dissolved inorganic nutrients in seawater were quantified on water samples (ca. 100 ml)  taken from each site and filtered through a GF/F filter and stored in acid-washed bottles and frozen at -20 °C until analyzes.  Dissolved inorganic nutrients—ammonium (NH~4~^+^), nitrate + nitrite (NO~3~^-^ + NO~2~^-^), phosphate (PO~4~^3-^), and silicate (Si(OH)~4~)—were measured at University of Hawai‘i at Mānoa SOEST Laboratory for Analytical Biogeochemistry using a Seal Analytical AA3 HR nutrient autoanalyzer and expressed as μmol l^-1^.   
  
Silicate showed no effects (p > 0.323). Phosphate increased in the winter (p=0.046) most notably at northern sites. N+N was higher in northern sites relative to southern sites and increased during the winter at all sites compared to the summer. Ammonium increased in the winter as well (p <0.001).  
  
```{r nutrients, fig.dim=c(7,3), fig.align='center', results='hide'}
#########################
#########################
# nutrients
nutr<-read.csv("data/environmental/PanKBay_nutrients.csv")

#models
mod<-lm(silicate~Location+Date, data=nutr); Anova(mod, type=2)
mod<-lm(phosphate~Location+Date, data=nutr); Anova(mod, type=2)
mod<-lm(N.N~Location+Date, data=nutr); Anova(mod, type=2)
mod<-lm(ammonium~Location+Date, data=nutr); Anova(mod, type=2)

nutr$Date<-mdy(nutr$Date) # corrects date format
dates<-cbind("10-Aug '16", "20-Dec '16")

RfHIMB<-nutr[(nutr$Reef=="HIMB"), ]
Rf42<-nutr[(nutr$Reef=="R42"), ]
Rf46<-nutr[(nutr$Reef=="F1-46"), ]
RF10<-nutr[(nutr$Reef=="F8-R10"), ]

Reefs<-c("Reef 46", "Reef 42", "Reef 10", "HIMB")
Locations<-c("NW", "NE", "SW", "SE")
plot_colors<-c("mediumseagreen", "dodgerblue", "salmon", "orchid")

###############
# Phosphate
# par(mfrow=c(1,1), mar=c(2,4,1,1), mgp=c(2,0.5,0))

# figure layout
layout(matrix(c(1,2,3,4), nrow=1, byrow=TRUE))
par(mar=c(5,4.5,7,1.5))

###############
# Silicate
plot(y=Rf46$silicate, x=Rf46$Date, xaxt="n", type="o", xlab=NA, ylab=expression(paste("silicate"~(mu*mol~L^-1), sep="")), ylim=c(0, 15), pch=19, lty=2, cex=1, lwd=1, col=plot_colors[1], cex.axis=0.8)
axis(side=1, at=Rf46$Date, labels=dates, cex.axis=0.8) # plots Reef 46 / NW
#plots Reef 42/ NE
with(Rf46, lines(Rf42$silicate, x=Rf42$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[2]))
#plots Reef 10/ SW
with(Rf46, lines(RF10$silicate, x=RF10$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[3]))
#plots HIMB/ SE
with(RfHIMB, lines(RfHIMB$silicate, x=RfHIMB$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[4]))

###############
# Phosphate
plot(y=Rf46$phosphate, x=Rf46$Date, xaxt="n", type="o", xlab=NA, ylab=expression(paste("phosphate"~(mu*mol~L^-1), sep="")), ylim=c(0, 0.25), pch=19, lty=2, cex=1, lwd=1, col=plot_colors[1], cex.axis=0.8)
axis(side=1, at=Rf46$Date, labels=dates, cex.axis=0.8) # plots Rf46 /NW
#plots Reef 42 / NE
with(Rf46, lines(Rf42$phosphate, x=Rf42$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[2]))
#plots Reef 10 /SW
with(Rf46, lines(RF10$phosphate, x=RF10$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[3]))
#plots HIMB / SE
with(RfHIMB, lines(RfHIMB$phosphate, x=RfHIMB$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[4]))

###############
# N+N
plot(y=Rf46$N.N, x=Rf46$Date, xaxt="n", type="o", xlab=NA, ylab=expression(paste("nitrate+nitrite"~(mu*mol~L^-1), sep="")), ylim=c(0, 1.5), pch=19, lty=2, cex=1, lwd=1, col=plot_colors[1], cex.axis=0.8)
axis(side=1, at=Rf46$Date, labels=dates, cex.axis=0.8) # plots Reef 46/ NW
#plots Reef 42/ NE
with(Rf46, lines(Rf42$N.N, x=Rf42$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[2]))
#plots Reef 10 / SE
with(Rf46, lines(RF10$N.N, x=RF10$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[3]))
#plots HIMB / SW
with(RfHIMB, lines(RfHIMB$N.N, x=RfHIMB$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[4]))


###############
# Ammonium
plot(y=Rf46$ammonium, x=Rf46$Date, xaxt="n", type="o", xlab=NA, ylab=expression(paste("ammonium"~(mu*mol~L^-1), sep="")), ylim=c(0, 1.5), pch=19, lty=2, cex=1, lwd=1, col=plot_colors[1], cex.axis=0.8)
axis(side=1, at=Rf46$Date, labels=dates, cex.axis=0.8) # plots Reef 46/ NW
#plots Reef 42 /NE
with(Rf46, lines(Rf42$ammonium, x=Rf42$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[2]))
#plots Reef 10/ SW
with(Rf46, lines(RF10$ammonium, x=RF10$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[3]))
#plots HIMB /SE
with(RfHIMB, lines(RfHIMB$ammonium, x=RfHIMB$Date, type="o", pch=19, lty=2, cex=1, lwd=1, col=plot_colors[4]))
legend("topleft", legend=Locations, col=plot_colors[1:4], lwd=1, pch=19, lty=2, cex=0.8, bty="n", x.intersp=0.2, y.intersp=1.2, inset=c(0.01, 0), seg.len=1.5)

dev.copy(pdf, "figures/environmental/all.nutrients.pdf", encod="MacRoman", height=3, width=7)
dev.off()
```
### Suspended particulates
  
#### Gravimetric SPM
Total (organic + inorganic) suspended particulate matter (SPM) was quantified by collecting and filtering 0.5 L of seawater from each location during each season. Seawater was sieved at 243 μm to remove large debris and filtered onto a pre-combusted (4h, 450°C) GF/F filter (0.7 μm). Salts were removed by light rinsing with ddH~2~O. Filters were dried at 60°C for 24h and re-weighed to closest 0.001 g to obtain total SPM. Masses were normalized to a liter of water.  

```{r SPM models and figures, fig.dim=c(6,3.5)}
###### SPM
spm<-read.csv("data/environmental/PanKBay_SPM.csv")
spm$SPM..g.l<-spm$SPM..g.l*1000 # change to mg
spm$Date<-factor(spm$Date, levels=c("8/10/16", "12/20/16"))
colnames(spm)[4]="SPM.mg"
spm$Location<-ordered(spm$Location, c("NW", "NE", "SW", "SE"))

mod<-lm(SPM.mg~Location+Date, data=spm); Anova(mod, type=2)
posthoc<-emmeans(mod, ~Location)
CLD(posthoc, Letters=letters)
plot(allEffects(mod), par.strip.text=list(cex=0.7))

rm(mean) # this will remove 'mean' from library and let the function below proceed.
mean<-aggregate(SPM.mg~Date + Location+Reef, spm, mean)
se<-aggregate(SPM.mg~Date+Location+Reef, spm, std.error)

spm.df<-cbind(mean, se[c(0,4)])
colnames(spm.df)=c("Date", "Location", "Reef", "SPM", "se")
spm.df$Date<-ordered(spm.df$Date, c("8/10/16", "12/20/16"))
spm.df$Reef<-ordered(spm.df$Reef, c("F1-46", "R42", "F8-10", "HIMB"))
spm.df$Location<-ordered(spm.df$Location, c("NW", "NE", "SW", "SE"))


Reefs<-c("Reef 46", "Reef 42", "Reef 10", "HIMB")
Locations<-c("NW", "NE", "SW", "SE")
Date<-c("10-Aug '16", "20-Dec '16")
plot_colors2<-c("mediumturquoise", "skyblue3", "lightcoral", "plum")

#####
# figure formatting script
Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        axis.line=element_blank(),
        legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect("transparent", colour=NA),
        legend.text=element_text(size=10),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, colour = "black", size=0.8),
        aspect.ratio=1, 
        axis.ticks = element_line(colour = 'black', size = 0.4),
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10)) +
theme(legend.spacing.x = unit(0.2, 'cm'),
      legend.key.size = unit(0.4, "cm"))

pd <- position_dodge(0.7) #offset for error bars and columns
#####

# SPM (mg/l)
Fig.SPM<-ggplot(spm.df, aes(x=Date, y=SPM, fill=Location)) +
  geom_bar(colour=c("plum","lightcoral", "skyblue3","mediumturquoise","plum","lightcoral", "skyblue3", "mediumturquoise"),
           stat="identity", position = pd, width=0.7, size=0.3) +
  geom_errorbar(aes(ymin=SPM-se, ymax=SPM+se), 
                colour=c("plum","lightcoral", "skyblue3","mediumturquoise","plum","lightcoral", "skyblue3","mediumturquoise"),
                size=0.4, width=0, position=pd) +
  xlab("Sampling points") +
  ylab(expression(paste("SPM", ~(mg~L^-1), sep=""))) +
  scale_x_discrete(labels=Date) +
  scale_y_continuous(expand=c(0,0), limits=c(0, 5)) +
  scale_fill_manual(values=alpha(c(plot_colors2), 0.5), 
                    labels=Locations)+ Fig.formatting; Fig.SPM
ggsave(file="figures/environmental/SPM.pdf", height=4, width=4)
```
  
#### Isotopes of SPM/plankton  
  
Plankton tows and seawater collections to parameterized particulates and plankters as potential heterotrophic end members available to reef corals. Sampling was done at 4 sites where corals were collected [*North*: (Reef 42, fringe-Reef 46), and *South*: (HIMB, fringe-Reef 10)], as well as two reefs in central region of the bay where corals were not collected (*Central*: Reef 25, fringe-Reef 25) to increase spatial resolution of suspended particulate isotope sample sizes. Using size-fractioned materials collected in seawater and plankton tows, we examined the spatial (*among reef sites*) and temporal patterns (*among seasons*) in stable isotope values of size-fractioned end members. Carbon and nitrogen isotope values among the 6 reef sites were not significantly different (*p* > 0.140), season had marginal effects (*p* > 0.049), whereas fraction influenced isotope values significantly (*p*< 0.001). Therefore, isotope values were pooled among reefs and seasons to best interpret size-fraction isotope values.  *Samples were not acidified prior to analysis as to not affect nitrogen isotope values.*
  
```{r seawater isotopes}
SWiso<-read.csv("data/isotopes_SW_all times.csv")

mod<-(lm(d13C~Location+Season+SW.fraction..um, data=SWiso)); Anova(mod, type=2) # no location effect
mod<-(lm(d15N~Location+Season+SW.fraction..um, data=SWiso)); Anova(mod, type=2) # no location effect
posthoc<-emmeans(mod, ~Season)
CLD(posthoc, Letters=letters)

SWiso$Reef<-factor(SWiso$Reef, levels=c("F1-46", "R42", "F2-R25", "R25", "F8-R10", "HIMB"))
SWiso$Location<-factor(SWiso$Location, levels=c("NW", "NE", "CW", "CE", "SW", "SE"))
SWiso$SW.fraction..um<-factor(SWiso$SW.fraction..um, levels=c(">243", "<243", "100-243", "10-100", "0-10"))

winter.data<-SWiso[(SWiso$Season=="winter"),]
summer.data<-SWiso[(SWiso$Season=="summer"),]
```
  
These box plots show the seasonal isotope values for carbon and nitrogen according to size fractions.
```{r isotope sw figures boxplot1, results="hide", fig.cap="**Figure** *Size-fractioned sample isotope values stratified by seasons (summer and winter)*"}
# plots of SW isotopes by Season-- first showing by size, then by site
op<-par(mfrow = c(2,2), mar=c(5,5,2,1))

######### Sizes
# Summer size d13C
plot(d13C~SW.fraction..um, data=summer.data, ylim=c(-25,-10), 
     main=expression(paste("summer"~ delta^{13}, "C")), ylab=expression(paste(delta^{13}, "C (‰, V-PDB)")),
     col="paleturquoise3", cex.axis=0.7, cex.main=1, cex.lab= 0.8, xlab=expression(paste("Size Fraction (", mu,m,")")))

# Winter size d13C
plot(d13C~SW.fraction..um, data=winter.data, ylim=c(-25,-10), 
     main=expression(paste("winter"~ delta^{13}, "C")), ylab=expression(paste(delta^{13}, "C (‰, V-PDB)")),
     col="paleturquoise3", cex.axis=0.7, cex.main=1, cex.lab= 0.8, xlab=expression(paste("Size Fraction (", mu,m,")")))

# Summer size d15N
plot(d15N~SW.fraction..um, data=summer.data, ylim=c(3,10), 
     main=expression(paste("summer"~ delta^{15}, "N")), col="plum", cex.axis=0.7, cex.main=1, cex.lab= 0.8,
     xlab=expression(paste("Size Fraction (", mu,m,")")),
     ylab=expression(paste(delta^{15}, "N (‰, air)")))

# Winter size d15N
plot(d15N~SW.fraction..um, data=winter.data, ylim=c(3,10), 
     main=expression(paste("winter"~ delta^{15}, "N")), ylab=expression(paste(delta^{15}, "N (‰, air)")),
     col="plum", cex.axis=0.7, cex.main=1, cex.lab= 0.8, xlab=expression(paste("Size Fraction (", mu,m,")")))
```
  
These figures show the same size-fractioned isotope data as above, but stratified by location and pooled across seasons.  

```{r isotope sw figures boxplot2, results="hide", fig.cap="**Figure** *Isotope values in seawater particles stratified by sites (northwest to southeast)*"}
######## Sites
op<-par(mfrow = c(2,2), mar=c(5,5,2,1))

# Summer site d13C
plot(d13C~Location, data=summer.data, ylim=c(-25,-10), 
     main=expression(paste("summer"~ delta^{13}, "C")), ylab=expression(paste(delta^{13}, "C (‰, V-PDB)")),
     col="lightskyblue", cex.axis=0.7, cex.main=1, cex.lab= 0.8, xlab="Reef Sites")

# Winter site d13C
plot(d13C~Location, data=winter.data, ylim=c(-25,-10), 
     main=expression(paste("winter"~ delta^{13}, "C")), ylab=expression(paste(delta^{13}, "C (‰, V-PDB)")),
     col="lightskyblue", cex.axis=0.7, cex.main=1, cex.lab= 0.8, xlab="Reef Sites")

# Summer site d15N
plot(d15N~Location, data=summer.data, ylim=c(3,10), 
     main=expression(paste("summer"~ delta^{15}, "N")), col="salmon", cex.axis=0.7, cex.main=1, cex.lab= 0.8,
     ylab=expression(paste(delta^{15}, "N (‰, air)")), xlab="Reef Sites")

# Winter site d15N
plot(d15N~Location, data=winter.data, ylim=c(3,10), 
     main=expression(paste("winter"~ delta^{15}, "N")), ylab=expression(paste(delta^{15}, "N (‰, air)")),
     col="salmon", cex.axis=0.7, cex.main=1, xlab="Reef Sites")
```
  
Pooling the isotope data across sites and seasons (where effects were absent or negligible), this planktonic foodweb for carbon and nitrogen illustrates differences in the food sources and their isotopic composition.  
```{r SW isotope figure, results="hide", fig.cap="**Figure** *Isotope values for size-fractioned seawater particles and plankters pooled across seasons and reef sites*", fig.dim=c(4.5,4.5), fig.align='center'}

mod<-lm(d13C~SW.fraction..um, data=SWiso); Anova(mod, type=2)
posthoc<-emmeans(mod, ~SW.fraction..um)
CLD(posthoc, Letters=letters)

mod<-lm(d15N~SW.fraction..um, data=SWiso); Anova(mod, type=2)
posthoc<-emmeans(mod, ~SW.fraction..um)
CLD(posthoc, Letters=letters)


rm(mean)
####
#### making scatter for d15N and d13C, pooled across seasons and sites
mix.N.mean<-aggregate(d15N~SW.fraction..um, data=SWiso, mean)
mix.N.se<-aggregate(d15N~SW.fraction..um, data=SWiso, std.error)
mix.C.mean<-aggregate(d13C~SW.fraction..um, data=SWiso, mean)
mix.C.se<-aggregate(d13C~SW.fraction..um, data=SWiso, std.error)
mix.data<-cbind(mix.N.mean, mix.C.mean[c(2,0)], mix.N.se[c(2,0)], mix.C.se[c(2,0)]); colnames(mix.data)=c("fraction", "d15N", "d13C", "d15N.se", "d13C.se")

colors=c("#FF6A6A", "#00B2EE", "#FFB90F", "#3CB371", "#8B7500")
op<-par(mfrow = c(1,1), mar=c(5,4,1,5),xpd=TRUE, pty="sq")

size.labels=c(expression(paste("> 243"~mu,m)), expression(paste("< 243"~mu,m)), expression(paste("100-243"~mu,m)), expression(paste("10-100"~mu,m)), expression(paste("< 10"~mu,m)))

#### make the plot
plot(d15N~d13C, data=mix.data, type="n", ylim=c(4.5,8), xlim=c(-23,-17), tck=-0.03, cex.axis=0.7, cex.lab=0.7,
     ylab=expression(paste(delta^{15}, "N (‰, air)")), xlab=expression(paste(delta^{13}, "C (‰, V-PDB)")))
legend("topleft", inset=c(0.05,0.0), legend=size.labels, col=colors, pch=19, cex=0.6, bty="n", x.intersp=1.8, y.intersp = 1.4)
arrows(mix.data$d13C-mix.data$d13C.se, mix.data$d15N, mix.data$d13C+mix.data$d13C.se, mix.data$d15N, length=0.0, angle=90, code=3, lwd=0.7, col=colors)
arrows(mix.data$d13C, mix.data$d15N-mix.data$d15N.se, mix.data$d13C, mix.data$d15N+mix.data$d15N.se, length=0.0, angle=90, code=3, lwd=0.7, col=colors)
points(d15N~d13C, data=mix.data, pch=19, cex=0.8, col=colors)

dev.copy(pdf, "figures/environmental/iso.sources.KBay.pdf", encod="MacRoman", height=4, width=4)
dev.off()
```


## Biology
```{r Biological responses, results="hide"}
################################
### Biological responses
################################

#data : this is the master file

# add in light at depth column from df.light dataframe
data$Light<-df.light$Light

##### produce a categorical depth bin ####
depth<-data$newDepth
data$depth.bin<-factor(ifelse(depth<2, "<2m", ifelse(depth >2 & depth <4, "2-4m", ifelse(depth >4 & depth <6, "4-6m", ">6m"))), levels=c("<2m", "2-4m", "4-6m", ">6m"))

aggregate(Sample.ID~depth.bin+Season+Location, data, length)
data$depth.bin.small<-factor(ifelse(depth<4, "<4m", ">4m"), levels= c("<4m", ">4m"))

################################################
# calculate, normalized dependent variables
################################################
str(data)
data$cells.ml<-as.numeric(data$cells.ml)

# helpful shorthand
SA<-data$surface.area # surface area in cm2
blastate<-data$total.blastate.ml # tissue slurry blastate in ml

# AFDW.mg. == convert AFDW g to mg, mutiply by blastate volume, divide by cm2
data$biomass<- (data$mg.biomass.ml*blastate)/SA

# Symbiodinium.cells. == cell.ml * blastate / SA
data$zoox<- (data$cells.ml*blastate)/SA

# total chlorophyll == ug.chl.a.ml * blastate + ug.chl.c2.ml * blastate / SA
data$chltot<-(data$ug.chl.a.ml)+(data$ug.chl.c2.ml)*blastate/SA

# pg.chlorophyll.a..cell + pg.chlorophyll.c2..cell == ug.chltot.ml * 10^6 / cells.ml
data$chlcell<- (data$ug.chl.a.ml*10^6+data$ug.chl.c2.ml*10^6)/data$cells.ml
```


### qPCR
```{r qPCR data, results="hide"}
####################
# qPCR
#########

# qPCR

library(devtools)
# Use steponeR to import data and calculate proporation of C and D symbionts
source_url("https://raw.githubusercontent.com/jrcunning/steponeR/master/steponeR.R")
Mcap.plates <- list.files(path="data/qPCR", pattern = "txt$", full.names = T); Mcap.plates
Mcap <- steponeR(files=Mcap.plates, delim="\t",
                 target.ratios=c("C.D"),
                 fluor.norm=list(C=2.26827, D=0),
                 copy.number=list(C=33, D=3),
                 ploidy=list(C=1, D=1), 
                 extract=list(C=0.813, D=0.813))

Mcap <- Mcap$result
head(Mcap)

# remove +/-control
Mcap <- Mcap[grep("+C52", Mcap$Sample.Name, fixed=T, invert = T), ]
Mcap <- Mcap[grep("H2O", Mcap$Sample.Name, fixed=T, invert = T), ]

# to remove any early-amplification CT noise
Mcap$C.CT.mean[which(Mcap$C.CT.mean < 15)] <- 0

#Remove failed samples, i.e., those where either C or D were NOT found in both reps
Mcap$fail <- ifelse(Mcap$C.reps < 2 & Mcap$D.reps < 2, TRUE, FALSE)
fails <- Mcap[Mcap$fail==TRUE, ]
Mcap <- Mcap[which(Mcap$fail==FALSE),]

# replace CT means with 'NA' as zero
Mcap$C.CT.mean[is.na(Mcap$C.CT.mean)] <-0
Mcap$D.CT.mean[is.na(Mcap$D.CT.mean)] <-0

Mcap$C.D[is.na(Mcap$C.D)] <- 1 # sets all infinity (= 100% C) to 1.0

# caluclate proportion C and proprtion D where C and D are both present
Mcap$propC<- Mcap$C.D / (Mcap$C.D + 1)
Mcap$propD<- 1 / (Mcap$C.D + 1)

# where C and D are not cooccuring...
# if C.D = 1 = 100% C, make 'PropC' = 1 and 'PropD' = 0
# if C.D = 0 = 100% D, make 'PropD' = 1 and 'PropC' = 0
Mcap$propC[which(Mcap$C.D==1)] <- 1
Mcap$propD[which(Mcap$propC==1)] <- 0
Mcap$propD[which(Mcap$C.D==0)] <- 1

# calculate FOUR COMMUNITY categories: C, C>D, D>C, D
Mcap$Mix <- factor(ifelse(Mcap$propC > Mcap$propD, ifelse(Mcap$propD!= 0, "CD", "C"), ifelse(Mcap$propD > Mcap$propC, ifelse(Mcap$propC!=0, "DC", "D"), NA)), levels=c("C", "CD", "DC", "D"))

# Identify SINGLE dominant symbiont clade: C or D
Mcap$Dom <- factor(substr(as.character(Mcap$Mix), 1, 1))


######## look for duplicates in dataset by year and type of event (bleach/recover)
Mcap[duplicated(Mcap$Sample.Name), ] ## duplicates

# remove duplicated
Mcap<-Mcap[!(Mcap$Sample.Name=="HIMB_15" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R10_05" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R42_06" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R46_01" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R46_02" & Mcap$File.Name=="Wall_PanKbay_plate2.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R46_03" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="HIMB_13" & Mcap$File.Name=="Wall_PanKbay_plate2.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="HIMB_14" & Mcap$File.Name=="Wall_PanKbay_plate2.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R10_15" & Mcap$File.Name=="Wall_PanKbay_plate3.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R10_15" & Mcap$File.Name=="Wall_PanKbay_plate1.txt"),] 
Mcap<-Mcap[!(Mcap$Sample.Name=="R42_11" & Mcap$File.Name=="Wall_PanKbay_plate2.txt"),] 

# parse Sample ID and Site from "Site.Name"
Mcap<-cbind(Mcap, colsplit(Mcap$Sample.Name, pattern= "_", c("Reef", "Sample.ID")))
Mcap$Season<-as.factor("winter")
Mcap$Reef<-as.factor(Mcap$Reef)

Mcap$Reef<-revalue(Mcap$Reef, c("R10"="F8-R10", "R46"="F1-R46")) # rename factor levels

# make new factors for bay region and reef type
Mcap$Bay.region <- ifelse(Mcap$Reef=="R42" | Mcap$Reef=="F1-R46", "northern", "southern")
Mcap$Reef.type <- ifelse(Mcap$Reef=="R42" | Mcap$Reef=="HIMB", "patch", "fringe")
Mcap$Location <- ifelse(Mcap$Reef=="F1-R46", "NW", ifelse(Mcap$Reef=="R42", "NE", 
                       ifelse(Mcap$Reef=="F8-R10", "SW", "SE")))

### reorder columns and finish
Mcap<-Mcap[, c(17,15,20,19,18,16,1:14)] # reordered to match masterdata, and finish

### structure winter and summer qPCR dataframes to have same columns and combine dataframe 
qPCR.winter<-Mcap[ , (names(Mcap) %in% 
        c("Season", "Reef", "Location", "Reef.type", "Bay.region", "Sample.ID", "propC", "propD", "Mix", "Dom"))]
qPCR.summer<-qPCR.Innis[ , (names(qPCR.Innis) %in% 
        c("Season", "Reef", "Location", "Reef.type", "Bay.region", "Sample.ID", "propC", "propD", "Mix", "Dom"))] 

# merge qPCR files
qPCR.all<-rbind(qPCR.winter, qPCR.summer)

# add to master data
data.all<-merge(data, qPCR.all, by=c("Season", "Reef", "Location", "Reef.type", "Bay.region", "Sample.ID"), all.x=T)

###### remove columns no longer needed, update "Depth" to be tide-corrected depth )= newDepth
data.trim<-data.all[ , !(names(data.all) %in% c("total.blastate.ml", "Date", "Time.of.collection", "Depth..m", "Time.r", "surface.area.cm2", "cells.ml", "ug.chl.a.ml", "ug.chl.c2.ml", "mg.biomass.ml", "host..mass.mg", "host..ugN", "host..ugC", "symb..mass.mg", "symb..ugN", "symb..ugC", "stationId", "datum", "TimeUTC", "TideHT", "Time"))]

data.trim$symb..C.N[data.trim$symb..C.N>=12.520270]=NA # set this outlier to NA
```

**qPCR figure**
The distribution of C and D symbiont types is modeled using a logistic regression with dominant symbiont community (C vs. D) as a response and *Depth (m)*, *Season*, and reef *Location* as a predictor. A  generalized linear model with a binomial distribution and logit link function is used. Model selection (by model AIC values) between a fully crossed model (*crossed*) and additive model (*add*) were compared. The additive mode best fit the data; main effects were tested in *anova* with a Chi-square test.  

```{r qPCR models Depth predictor, fig.dim=c(6,4)}
## qPCR figures

#####
final.data<-data.trim[,c(17, 1:5, 18:25, 7:16, 26:29)] # for general use
model.data<-data.trim[,c(17, 1:5, 18:25, 7:16, 26:29)] # for models, transformations

#########################
#########################
#########################

# Plots with DEPTH as the predictor
# qPCR and symbionts

#########################
###### Plot Dominant Symbiont and Depth (both seasons)
Symb<-final.data
Symb$Reef <- factor(Symb$Reef, levels = c("F1-R46", "R42", "F8-R10", "HIMB")) # set levels
Symb$Location <- factor(Symb$Location, levels = c("NW", "NE", "SW", "SE")) # set levels

Symb$Dominant <- ifelse(Symb$Dom=="D", 1, 0)
add <-glm(Dominant~newDepth+Season+Location, family = "binomial", data = Symb)
crossed <-glm(Dominant~newDepth*Season+Location, family = "binomial", data = Symb)
AIC(add, crossed) # crossed model best
anova(crossed, test = "Chisq")

results.all<-crossed

#summary(results.all)
plot(allEffects(results.all), par.strip.text=list(cex=0.6))

results.all.mod <-glm(Dominant~newDepth, family = "binomial", data = Symb)
fitted.all <- predict(results.all.mod, newdata = list(newDepth=seq(0,10,0.1)), type = "response")

###### summer only symbionts
sum.dat<-Symb[(Symb$Season=="summer"),]
results.sum=glm(Dominant~newDepth, family = "binomial", data = sum.dat)
anova(results.sum, test = "Chisq")
#summary(results.sum)
fitted.sum <- predict(results.sum, newdata = list(newDepth=seq(0,10,0.1)), type = "response")
# plot(fitted.sum, ylab="proportion D", ylim=c(0,1))

###### winter only symbionts
wint.dat<-Symb[(Symb$Season=="winter"),]
results.win=glm(Dominant~newDepth, family = "binomial", data = wint.dat)
anova(results.win, test = "Chisq")
#summary(results.win)
fitted.win <- predict(results.win, newdata = list(newDepth=seq(0,10,0.1)), type = "response")
# plot(fitted.win, ylab="proportion D", ylim=c(0,1))
```
  
Logistic regression of the probability of *Montipora capitata* have a clade D-dominant symbiont community (probability of 1.0) versus one dominated by clade C symbiont (probability of 0). Both seasons show similar patterns, although the probability of corals being clade D-dominant increases in winter months as a function of Depth relative to summer months.  
  
```{r qPCR figures, results="hide",fig.dim=c(6,4), fig.cap="**Figure** Probability of *Montipora capitata* hosting clade D symbionts across a depth gradient in summer and winter seasons. Lines represent model fit to data by logistic regression for summer alone, winter alone, and combined (summer + winter) data"}

######
######
## Figure of Dominant symbiont clades across seasons
## **Note** where points equal 0.0 is 100% D, where they equal 0 is 100% C
par(mar=c(5,4,3,2))
plot(sum.dat$propD~sum.dat$newDepth, xlab="Depth (m)", ylab = "Proportion of Clade D Symbiont", pch=19, col="salmon", xlim=c(0,10), ylim=c(0.0, 1.0), cex=0.5, cex.lab=0.8)
par(new=T)
plot(wint.dat$propD~wint.dat$newDepth, pch=19, col="lightskyblue", xlim=c(0,10), ylim=c(0.0, 1.0), xaxt="n", xlab="", ylab="", cex=0.5, cex.lab=0.8)
lines(fitted.all ~ seq(0,10,0.1), col="gray30", lwd=1, lty=2)
lines(fitted.sum ~ seq(0,10,0.1), col="coral", lwd=1)
lines(fitted.win ~ seq(0,10,0.1), col="lightskyblue", lwd=1)
legend("topright", pch=c(19,19, NA), lty=c(1,1,2), col=c("coral", "lightskyblue", "gray30"), legend=c("Summer", "Winter", "Combined"), lwd=1, bty="n", x.intersp=1, pt.cex=0.8, y.intersp=2, cex=0.5, inset=c(-0.005, -0.01), seg.len=4)

dev.copy(pdf, "figures/symbionts/Symbionts_by_Season_depth.pdf", encod="MacRoman", height=4, width=4)
dev.off()
```
  
Seen another way--**Histograms**. By separating these data into 2 histograms the probability of clade D- (1.0) and clade C-dominance (0.0) can be visualized. Here it is clear that there is a greater probability of finding corals with clade D dominant communites at shallow depths, whereas in winter there is a slightly greater probability of finding clade D in corals with increasing depth.
```{r Symbiont qPCR and light at depth histograms by seasons, results='hide', fig.dim=c(6,4), fig.cap="**Figure** Histograms of probability of *Montipora capitata* hosting clade D symbionts across a depth gradient among seasons. Lines represent model fit to data by logistic regression"}
#######
#######
par(mfrow=c(1,2))
Dom <- subset(Symb, !is.na(newDepth) & !is.na(Dominant))
Dom.sum<-Dom[(Dom$Season=="summer"),]
Dom.win<-Dom[(Dom$Season=="winter"),]

logi.hist.plot(Dom.sum$newDepth, Dom.sum$Dominant, boxp = FALSE, type = "hist", col="coral", xlabel = "Depth (m)", ylabel = "", ylabel2 = "", main="summer")
mtext(side = 2, text = "Probability of Clade D", line = 3, cex = 1)

logi.hist.plot(Dom.win$newDepth, Dom.win$Dominant, boxp = FALSE, type = "hist", col="lightskyblue", xlabel = "Depth (m)", ylabel = "", ylabel2 = "", main="winter")
mtext(side = 4, text = "Frequency", line = 0.5, cex=1)
mtext(side = 4, text = "C                                             D", line = 0.5, cex = 0.8)
dev.copy(pdf, "figures/symbionts/Symb_Season_Light_logistic.pdf", encod="MacRoman", height=5, width=8)
dev.off()
```

  
```{r Light at depth as predictor in qPCR, results='hide', fig.dim=c(6,6), fig.align='center', fig.cap="**Figure** Probability of *Montipora capitata* hosting clade D symbionts across a **LIGHT gradient** in summer and winter seasons. Lines represent model fit to data by logistic regression for summer alone, winter alone, and combined (summer + winter) data", eval=FALSE}
#
#########################
#########################

# this code runs the same as above, except using colony LIGHT-AT-DEPTH as a predictor instead of depth

# Light as a predictor
# qPCR and symbionts

#########################
###### Plot Dominant Symbiont and Depth (both seasons)
Symb<-final.data
Symb$Dominant <- ifelse(Symb$Dom=="D", 1, 0)
add<-glm(Dominant~Light+Season+Location, family = "binomial", data = Symb)
crossed<-glm(Dominant~Light*Season*Location, family = "binomial", data = Symb)
#AIC(add, crossed)

anova(add, test = "Chisq")
#summary(add)

results.all<-add

results.all.mod<-glm(Dominant~Light, family = "binomial", data = Symb)
fitted.all <- predict(results.all.mod, newdata = list(Light=seq(0,25,0.1)), type = "response")

###### summer only symbionts
sum.dat<-Symb[(Symb$Season=="summer"),]
results.sum<-glm(Dominant~Light, family = "binomial", data = sum.dat)
#anova(results.sum, test = "Chisq")
#summary(results.sum)
fitted.sum <- predict(results.sum, newdata = list(Light=seq(0,25,0.1)), type = "response")
# plot(fitted.sum, ylab="proportion D", ylim=c(0,1))

###### winter only symbionts
wint.dat<-Symb[(Symb$Season=="winter"),]
results.win<-glm(Dominant~Light, family = "binomial", data = wint.dat)
#anova(results.win, test = "Chisq")
#summary(results.win)
fitted.win <- predict(results.win, newdata = list(Light=seq(0,25,0.1)), type = "response")
# plot(fitted.win, ylab="proportion D", ylim=c(0,1))

######
######
## Figure of Dominant symbiont clades across seasons
## **Note** where points equal 0.0 is 100% D, where they equal 0 is 100% C
par(mar=c(5,4,3,2))
plot(sum.dat$propD~sum.dat$Light, xlab="Light (DLI)", ylab = "Proportion of Clade D Symbiont", pch=19, col="salmon", xlim=c(0,25), ylim=c(0.0, 1.0), cex=0.5, cex.lab=0.8)
par(new=T)
plot(wint.dat$propD~wint.dat$newDepth, pch=19, col="lightskyblue", xlim=c(0,25), ylim=c(0.0, 1.0), xaxt="n", xlab="", ylab="", cex=0.5)
lines(fitted.all ~ seq(0,25,0.1), col="gray30", lwd=1, lty=2)
lines(fitted.sum ~ seq(0,25,0.1), col="coral", lwd=1)
lines(fitted.win ~ seq(0,25,0.1), col="lightskyblue", lwd=1)
legend("bottomright", pch=c(19,19, NA), lty=c(1,1,2), col=c("coral", "lightskyblue", "gray30"), legend=c("Summer", "Winter", "Combined"), lwd=1, bty="n", x.intersp=1, pt.cex=0.7, y.intersp=2, cex=0.5, inset=c(0.1, 0.15), seg.len=4)

dev.copy(pdf, "figures/symbionts/Symbionts_by_Season_light.pdf", encod="MacRoman", height=4, width=4)
dev.off()


#######
#######
par(mfrow=c(1,2))
Dom <- subset(Symb, !is.na(Light) & !is.na(Dominant))
Dom.sum<-Dom[(Dom$Season=="summer"),]
Dom.win<-Dom[(Dom$Season=="winter"),]

logi.hist.plot(Dom.sum$Light, Dom.sum$Dominant, boxp = FALSE, type = "hist", col="coral", xlabel = "Light-at-depth (DLI)", ylabel = "", ylabel2 = "", main="summer")
mtext(side = 2, text = "Probability of Clade D", line = 3, cex = 1)

logi.hist.plot(Dom.win$Light, Dom.win$Dominant, boxp = FALSE, type = "hist", col="lightskyblue", xlabel = "Light-at-depth (DLI)", ylabel = "", ylabel2 = "", main="winter")
mtext(side = 4, text = "Frequency", line = 0.5, cex=1)
mtext(side = 4, text = "C                                             D", line = 0.5, cex = 0.8)
dev.copy(pdf, "figures/symbionts/Symb_Season_Light_logistic.pdf", encod="MacRoman", height=5, width=8)
dev.off()
```

**Model assumptions**
```{r assumptions, include=FALSE}
#### assumptions

###### model dataframe for analysis
#####
# model.data is dataframe for analysis, ordered as <-data.trim[,c(17, 1:5, 18:25, 7:16, 26:29)]

##########
##########

##transformations
model.data$zoox<-log(model.data$zoox)
model.data$chlcell<-log(model.data$chlcell)
model.data$host..C.N<-log(model.data$host..C.N)
model.data$symb..C.N<-log(model.data$symb..C.N)

#model.data$d13C..host.sym<-sign(model.data$d13C..host.sym)*log(abs(model.data$d13C..host.sym)+1)

## tests for assumptions
for(i in c(11:23)){
  Y<-model.data[,i]
  full<-lmer(Y~Season*Light*Dom + (1|Location), data=model.data, na.action=na.exclude)
  #Y.shapiro <- shapiro.test(R) #runs a normality test on residuals
  #print(Y.shapiro) # null = normally distrubuted (P<0.05 = non-normal
  
  op<-par(mfrow = c(2,3), mar=c(5,4,1,2), pty="sq")
  plot(full, add.smooth = FALSE, which=1)
  R <- resid(full) #save glm residuals
  QQ <- qqnorm(R, main = colnames(model.data)[i]) 
  QQline <- qqline(R)
  hist(R, xlab="Residuals", main = colnames(model.data)[i])
  plot(model.data$Season, R, xlab=colnames(model.data)[i], ylab="Residuals")
  plot(model.data$Light, R, xlab=colnames(model.data)[i], ylab="Residuals")
  plot(model.data$Dom, R, xlab=colnames(model.data)[i], ylab="Residuals")
  plot(model.data$Location, R, xlab=colnames(model.data)[i], ylab="Residuals")
}
```

#### Physiology models
**Total Biomass**
```{r total biomass}
########## ########## 
######### biomass ---- 
Y<-model.data$biomass
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)

print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.biomass=var.table
var.biomass$response<-"biomass"


plot(allEffects(add), ylab="biomass", par.strip.text=list(cex=0.7))
```
  
  
**Symbiont density**
```{r symbiont density}
######### symbionts-- 
Y<-model.data$zoox
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+Season:Light + (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)

print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.symb=var.table
var.symb$response<-"symb"

posthoc<-emmeans(add, ~Dom)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="symbiont density", par.strip.text=list(cex=0.7))
```
  

**Chlorophyll a**
```{r chlorophyll a}
######### chltotal-- 
Y<-model.data$chltot
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+Season:Dom + (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)

print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.chl=var.table
var.chl$response<-"chl"

posthoc<-emmeans(add, ~Season)
CLD(posthoc, Letters=letters)

posthoc<-emmeans(add, ~Dom|Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="total chlor", par.strip.text=list(cex=0.7))
```
  
**Chlorophyll per symbiont cell**
```{r chlorophyll per cell}
######### chlcell -- 
Y<-model.data$chlcell
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)

print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.chlcell=var.table
var.chlcell$response<-"chlcell"

plot(allEffects(add), ylab="chla cell", par.strip.text=list(cex=0.7))
#ranef(add)
#ranova(add)
#fixef(add)
#sjp.lmer(add, y.offset = .4)
```
  
#### Isotope models  
**host d13C**
```{r host d13C}
########## host..d13C -- 
Y<-model.data$host..d13C
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ Season:Light+ Season:Dom+(1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)

print(anova(add), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d13C.H=var.table
var.d13C.H$response<-"d13C.H"

posthoc<-emmeans(add, ~Dom)
CLD(posthoc, Letters=letters)

posthoc<-emmeans(add, ~Dom| Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="d13Chost", par.strip.text=list(cex=0.7))
```
  
**symbiont d13C**
```{r symbiont d13C}
########## symb..d13C --
Y<-model.data$symb..d13C
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ Season:Dom +(1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use additive model

summary(add)
ranova(add)
print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d13C.S=var.table
var.d13C.S$response<-"d13C.S"

posthoc<-emmeans(add, ~Dom)
CLD(posthoc, Letters=letters)

posthoc<-emmeans(add, ~Dom| Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="d13Csymb", par.strip.text=list(cex=0.7))
```
  
**host-symbiont d13C**
```{r host-symb d13C}
######### d13C..host.sym --
Y<-model.data$d13C..host.sym
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ Season:Light +Season:Dom +(1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=4)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d13C.HS=var.table
var.d13C.HS$response<-"d13C.HS"

posthoc<-emmeans(add, ~Dom)
CLD(posthoc, Letters=letters)

posthoc<-emmeans(add, ~Dom|Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="d13C-hs", par.strip.text=list(cex=0.7))
```
  
**skeleton d13C**
```{r skelton d13C}
####### d13C..skel --
Y<-model.data$d13C..skel
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=4)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d13C.sk=var.table
var.d13C.sk$response<-"d13C.sk"

posthoc<-emmeans(add, ~Season)
CLD(posthoc, Letters=letters)
plot(allEffects(add), ylab="d13C-skel", par.strip.text=list(cex=0.7))
```
  
**host d15N**
```{r host d15N}
####### host..d15N --
Y<-model.data$host..d15N
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+(1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=4)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d15N.H=var.table
var.d15N.H$response<-"d15N.H"

plot(allEffects(add), ylab="d15Nhost", par.strip.text=list(cex=0.7))
```
  
**symbiont d15N**
```{r symbiont d15N}
######## symb..d15N --
Y<-model.data$symb..d15N
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ Season:Dom + (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=6)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d15N.S=var.table
var.d15N.S$response<-"d15N.S"

posthoc<-emmeans(add, ~Dom|Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="d15Nsymb", par.strip.text=list(cex=0.7))
```
  
**host-symbiont d15N**
```{r host-symbiont d15N}
####### d15N..host.sym  -- 
Y<-model.data$d15N..host.sym
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ Season:Dom+  (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=4)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.d15N.HS<-var.table
var.d15N.HS$response<-"d15N.HS"

posthoc<-emmeans(add, ~Dom|Season)
CLD(posthoc, Letters=letters)

plot(allEffects(add), ylab="d15N-hs", par.strip.text=list(cex=0.7))
```
  
**host C:N**
```{r host CN}
###### host..C.N --
Y<-model.data$host..C.N
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=4)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.CN.H<-var.table
var.CN.H$response<-"CN.Host"

plot(allEffects(add), ylab="C:N host", par.strip.text=list(cex=0.7))
```
  
**symbiont C:N**
```{r symbiont CN}
####### symb..C.N -- 
Y<-model.data$symb..C.N
full<-lmer(Y~Season*Light*Dom+ (1|Location), data=model.data, na.action=na.exclude)
add<-lmer(Y~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
anova(full, add) #use add model

summary(add)
ranova(add)

print(anova(add, type=2), digits=5)
var.table<-as.data.frame(VarCorr(add),comp="Variance")
var.table$prop.var<-c(var.table$vcov[1]/(var.table$vcov[1]+var.table$vcov[2]), "")
var.CN.S<-var.table
var.CN.S$response<-"CN.Symb"

plot(allEffects(add), ylab="C:N symb", par.strip.text=list(cex=0.7))
```

Using compiled models above, a summary table and figure for random effects can be generated. This table figure shows the proportion of variance explained by the random effect *Location*. For symbiont tissue C:N,  Location explained <0.00001 of variance. 
```{r random variance, fig.dim=c(7,3), fig.cap="**Figure** *Proportion of model variance explained by the random effect of **Location**, representing the four reef locations where corals were collected within each season*"}
# random effect table

rand.eff.table<-rbind(var.biomass, var.symb, var.chl, var.chlcell, var.d13C.H, var.d13C.S, var.d13C.HS, var.d13C.sk, var.d15N.H, var.d15N.S, var.d15N.HS, var.CN.H, var.CN.S); rand.eff.table=rand.eff.table[-2:-3]
colnames(rand.eff.table)<-c("group", "variance", "stdev", "prop.var", "response")
rand.eff.table=rand.eff.table[,c(5,1:4)]
rand.eff.summary<-rand.eff.table[,c(1,5)]

rand.eff.df<- rand.eff.summary[-which(rand.eff.summary$prop.var==""), ] # removing blank values
rand.eff.df$prop.var<-as.numeric(rand.eff.df$prop.var)

rand.eff.df$response<-as.factor(rand.eff.df$response)
rand.eff.df$response<-factor(rand.eff.df$response, levels = c("biomass", "symb", "chl", "chlcell", 
                                        "d13C.H", "d13C.S", "d13C.HS", "d13C.sk", 
                                        "d15N.H", "d15N.S", "d15N.HS",
                                        "CN.Host", "CN.Symb"))

var.labs<-c("biomass", "symbionts", "chlorophyll", "chl/cell", 
            (expression(paste(delta^{13}, C[H]))), (expression(paste(delta^{13}, C[S]))),
            (expression(paste(delta^{13}, C[H-S]))), (expression(paste(delta^{13}, C[Sk]))),
            (expression(paste(delta^{15}, N[H]))), (expression(paste(delta^{15}, N[S]))),
            (expression(paste(delta^{15}, N[H-S]))), 
            (expression(paste(C:N[H]))), (expression(paste(C:N[S]))))


# make plot
Fig.rand.eff<-ggplot(rand.eff.df, aes(x=response, y=prop.var, fill=response)) +
  geom_bar(stat="identity", position = pd, width=0.7, size=0.4) +
  theme(axis.text.x = element_text(size=10, angle=45, hjust = 1)) +
  scale_x_discrete(name="Responses", label=var.labs) +
  theme(axis.title.y= element_text(size=10),
        axis.text.y= element_text(size=10))+
  ylab(expression(paste("variance proportion", sep=""))) +
  scale_y_continuous(expand=c(0,0), limits=c(0, 1)) + theme(legend.position="none"); Fig.rand.eff
ggsave(file="figures/models/variance.pdf", height=3.5, width=6)

```

### Figures
```{r PCA all data}
# multivariate test using adonis-- Manova, mutivariate analysis of variance
library(devtools)
install_github("vqv/ggbiplot")
library(ggbiplot)
require(graphics)

df.PCA<-final.data

# remove columns unnecessary for final analysis, few factors retained
df.PCA<-df.PCA[ , !names(df.PCA) %in% c("date.time", "newDepth", "Reef", "Reef.type", "Bay.region", "Light", "depth.bin.small", "d15N..host.sym", "d13C..host.sym", "d18O..skel", "propC", "propD","symb..C.N", "host..C.N", "Mix")]

# remove factors, leaving only "Location"
# subset(df.PCA, select = c(-Season, -newDepth, -Light, -Dom))

###################
# PCA by LOCATION 
# apply PCA - scale. = TRUE for center as advised
PC.Kbay <- prcomp(df.PCA[,c(-1:-3,-13)], center = TRUE, scale= TRUE)  
# correlatin matrix helps to standardize the data and account for different scales

# print(PC.area) <<< to show loadings
PC.summary<-(summary(PC.Kbay)) #signficance of PCs: proportion of variance captured, cumulative variance
#In general, we are interested in keeping only those principal components whose eigenvalues are greater than 1. 

# the SDEV^2 is the eignevalue
ev<-PC.Kbay$sdev^2 # PC1-2 have eignevalues >1
# ev.area/sum(ev.area) #gives proportional eignevalues

newdat<-PC.Kbay$x[,1:4] # 4 PCs
plot(PC.Kbay, type="lines", main="PC.Kbay eigenvalues") #plots PCA, equivalent to ev.area


####### plot: Season
## PC1 and PC2
PC.Seas.fig <- ggbiplot(PC.Kbay, choices = 1:2, obs.scale = 1, var.scale = 1, 
              groups= df.PCA[,1], ellipse = TRUE, ellipse.prob = 0.90,
              circle = FALSE, alpha=0.6) +
  scale_color_discrete(name = '') +
  theme_bw() +
  scale_x_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+
  scale_y_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+ 
  theme(axis.ticks.length=unit(-0.25, "cm"), axis.text.y=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm")), axis.text.x=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"))) +
  theme(legend.text=element_text(size=15)) +
  theme(panel.background = element_rect(colour = "black", size=1))+
  theme(legend.key = element_blank())+
  theme(legend.direction = 'horizontal', legend.position = 'top') + theme(aspect.ratio=0.7)

print(PC.Seas.fig)
dev.copy(pdf, "figures/multivariate/PC.Seas.fig.pdf", height=5, width=5)
dev.off()

####### plot: Location
## PC1 and PC2 
PC.Loc.fig <- ggbiplot(PC.Kbay, choices = 1:2, obs.scale = 1, var.scale = 1, 
              groups= df.PCA[,2], ellipse = TRUE, ellipse.prob = 0.90,
              circle = FALSE, alpha=0.6) +
  scale_color_discrete(name = '') +
  theme_bw() +
  scale_x_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+
  scale_y_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+ 
  theme(axis.ticks.length=unit(-0.25, "cm"), axis.text.y=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm")), axis.text.x=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"))) +
  theme(legend.text=element_text(size=15)) +
  theme(panel.background = element_rect(colour = "black", size=1))+
  theme(legend.key = element_blank())+
  theme(legend.direction = 'horizontal', legend.position = 'top') + theme(aspect.ratio=0.7)

print(PC.Loc.fig)
dev.copy(pdf, "figures/multivariate/PC.Loc.fig.pdf", height=5, width=5)
dev.off()


#### PCA by Depth
PC.Depth.fig <- ggbiplot(PC.Kbay, choices = 1:2, obs.scale = 1, var.scale = 1, 
              groups= df.PCA[,3], ellipse = TRUE, ellipse.prob = 0.90,
              circle = FALSE, alpha=0.6) +
  scale_color_discrete(name = '') +
  theme_bw() +
  scale_x_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+
  scale_y_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+ 
  theme(axis.ticks.length=unit(-0.25, "cm"), axis.text.y=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm")), axis.text.x=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"))) +
  theme(legend.text=element_text(size=15)) +
  theme(panel.background = element_rect(colour = "black", size=1))+
  theme(legend.key = element_blank())+
  theme(legend.direction = 'horizontal', legend.position = 'top') + theme(aspect.ratio=0.7)

print(PC.Depth.fig)
dev.copy(pdf, "figures/multivariate/PC.Depth.fig.pdf", height=5, width=5)
dev.off()


#### PCA by Symb
PC.Symb.fig <- ggbiplot(PC.Kbay, choices = 1:2, obs.scale = 1, var.scale = 1, 
              groups= df.PCA[,13], ellipse = TRUE, ellipse.prob = 0.90,
              circle = FALSE, alpha=0.6) +
  scale_color_discrete(name = '') +
  theme_bw() +
  scale_x_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+
  scale_y_continuous(limits=c(-5, 5), breaks=pretty_breaks(n=5))+ 
  theme(axis.ticks.length=unit(-0.25, "cm"), axis.text.y=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm")), axis.text.x=element_text(margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"))) +
  theme(legend.text=element_text(size=15)) +
  theme(panel.background = element_rect(colour = "black", size=1))+
  theme(legend.key = element_blank())+
  theme(legend.direction = 'horizontal', legend.position = 'top') + theme(aspect.ratio=0.7)

print(PC.Symb.fig)
dev.copy(pdf, "figures/multivariate/PC.Symb.fig.pdf", height=5, width=5)
dev.off()

grid.arrange(PC.Seas.fig, PC.Loc.fig, PC.Symb.fig, PC.Depth.fig, ncol = 2)
G<-arrangeGrob(PC.Seas.fig, PC.Loc.fig, PC.Symb.fig, PC.Depth.fig, ncol=2)
ggsave(file="figures/multivariate/PCx4.png", G, height=7, width=8)

```

#### Physiology
```{r physiology figure dataframes, results="hide"}
#########################
# all data
df.fig<-data.trim[,c(17, 1:5, 18:25, 7:16, 26:29)]
table(df.fig$Dom:df.fig$Season)

# figure layout
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

##################
################## 

## season relationship
data.summer<-df.fig[df.fig$Season=="summer", ]
data.winter<-df.fig[df.fig$Season=="winter", ]

## Symbiont relationship
C.sum.df<-df.fig[(df.fig$Dom=="C" & df.fig$Season=="summer") ,]
C.win.df<-df.fig[(df.fig$Dom=="C" & df.fig$Season=="winter") ,]

D.sum.df<-df.fig[(df.fig$Dom=="D" & df.fig$Season=="summer") ,]
D.win.df<-df.fig[(df.fig$Dom=="D" & df.fig$Season=="winter") ,]

##transformations
# model.data$zoox<-log(model.data$zoox)
# model.data$chlcell<-log(model.data$chlcell)
# model.data$host..C.N<-log(model.data$host..C.N)
# model.data$symb..C.N<-log(model.data$symb..C.N)
```

```{r tidy fix, include=FALSE}
# issue with broom:tidy that currently won't support lmer model output in lmerTest
# work around from https://github.com/tidymodels/broom/issues/309
# run the function below and name all 'tidy' calls 'tidy_lmer'

tidy_lmer <- function(x, effects = c("ran_pars","fixed"),
                        scales = NULL, ## c("sdcor",NA),
                        ran_prefix=NULL,
                        conf.int = FALSE,
                        conf.level = 0.95,
                        conf.method = "Wald",
                        ...) {
    effect_names <- c("ran_pars", "fixed", "ran_modes")
    if (!is.null(scales)) {
        if (length(scales) != length(effects)) {
            stop("if scales are specified, values (or NA) must be provided ",
                 "for each effect")
        }
    }
    if (length(miss <- setdiff(effects,effect_names))>0)
        stop("unknown effect type ",miss)
    base_nn <- c("estimate", "std.error", "df", "statistic", "p.value")
    ret_list <- list()
    if ("fixed" %in% effects) {
        # return tidied fixed effects rather than random
        ret <- stats::coef(summary(x))

        # p-values may or may not be included
        nn <- base_nn[1:ncol(ret)]

        if (conf.int) {
            cifix <- confint(x,parm="beta_",method=conf.method,...)
            ret <- data.frame(ret,cifix)
            nn <- c(nn,"conf.low","conf.high")
        }
        if ("ran_pars" %in% effects || "ran_modes" %in% effects) {
            ret <- data.frame(ret,group="fixed")
            nn <- c(nn,"group")
        }
        ret_list$fixed <-
            fix_data_frame(ret, newnames = nn)
    }
    if ("ran_pars" %in% effects) {
        if (is.null(scales)) {
            rscale <- "sdcor"
        } else rscale <- scales[effects=="ran_pars"]
        if (!rscale %in% c("sdcor","vcov"))
            stop(sprintf("unrecognized ran_pars scale %s",sQuote(rscale)))
        ret <- as.data.frame(VarCorr(x))
        ret[] <- lapply(ret, function(x) if (is.factor(x))
                                 as.character(x) else x)
        if (is.null(ran_prefix)) {
            ran_prefix <- switch(rscale,
                                 vcov=c("var","cov"),
                                 sdcor=c("sd","cor"))
        }
        pfun <- function(x) {
            v <- na.omit(unlist(x))
            if (length(v)==0) v <- "Observation"
            p <- paste(v,collapse=".")
            if (!identical(ran_prefix,NA)) {
                p <- paste(ran_prefix[length(v)],p,sep="_")
            }
            return(p)
        }

        rownames(ret) <- paste(apply(ret[c("var1","var2")],1,pfun),
                                ret[,"grp"], sep = ".")

        ## FIXME: this is ugly, but maybe necessary?
        ## set 'term' column explicitly, disable fix_data_frame
        ##  rownames -> term conversion
        ## rownames(ret) <- seq(nrow(ret))

        if (conf.int) {
            ciran <- confint(x,parm="theta_",method=conf.method,...)
            ret <- data.frame(ret,ciran)
            nn <- c(nn,"conf.low","conf.high")
        }

        
        ## replicate lme4:::tnames, more or less
        ret_list$ran_pars <- fix_data_frame(ret[c("grp", rscale)],
                                            newnames = c("group", "estimate"))
    }
    if ("ran_modes" %in% effects) {
        ## fix each group to be a tidy data frame

        nn <- c("estimate", "std.error")
        re <- ranef(x,condVar=TRUE)
        getSE <- function(x) {
            v <- attr(x,"postVar")
            setNames(as.data.frame(sqrt(t(apply(v,3,diag)))),
                     colnames(x))
        }
        fix <- function(g,re,.id) {
             newg <- fix_data_frame(g, newnames = colnames(g), newcol = "level")
             # fix_data_frame doesn't create a new column if rownames are numeric,
             # which doesn't suit our purposes
             newg$level <- rownames(g)
             newg$type <- "estimate"

             newg.se <- getSE(re)
             newg.se$level <- rownames(re)
             newg.se$type <- "std.error"

             data.frame(rbind(newg,newg.se),.id=.id,
                        check.names=FALSE)
                        ## prevent coercion of variable names
        }

        mm <- do.call(rbind,Map(fix,coef(x),re,names(re)))

        ## block false-positive warnings due to NSE
        type <- spread <- est <- NULL
        mm %>% gather(term, estimate, -.id, -level, -type) %>%
            spread(type,estimate) -> ret

        ## FIXME: doesn't include uncertainty of population-level estimate

        if (conf.int) {
            if (conf.method != "Wald")
                stop("only Wald CIs available for conditional modes")

            mult <- qnorm((1+conf.level)/2)
            ret <- transform(ret,
                             conf.low=estimate-mult*std.error,
                             conf.high=estimate+mult*std.error)
        }

        ret <- dplyr::rename(ret,group=.id)
        ret_list$ran_modes <- ret
    }
    return(rbind.fill(ret_list))
}
```

**Tissue biomass**
```{r biomass figure, results="hide"}
##################
# Fig: biomass over season and depth
################## 
par(mfrow=c(1,2),mar=c(5,4.5,2,2))
mod<-lmer(biomass~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(biomass~Light, data=C.sum.df, col='red3', ylim=c(0, 80), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(biomass~Light, data=D.sum.df, col='blue', ylim=c(0, 80), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=expression(paste("biomass", ~(mg~cm^-2), sep="")), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(biomass~Light, data=C.win.df, col='red3', ylim=c(0, 80), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(biomass~Light, data=D.win.df, col='blue', ylim=c(0, 80), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]) , coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/physiology/PanKB.biomass.pdf", width=6, height=4)
dev.off()
```
  
**Total chlorophyll**
```{r chlorophylls figure, results="hide"}
##################
# Fig: chlorophyll (total) over season and depth
################## 
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model 
mod<-lmer(chltot~Season+Light+Dom+Season:Dom + (1|Location), data=model.data, na.action=na.exclude)
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

intercept<-coef(summary(mod))[1] # intercept
coef(summary(mod))["Seasonwinter",1] # winter, summer = 0
coef(summary(mod))["Light",1] # light relationship (slope for all figures)
coef(summary(mod))["DomD",1] # domD, domC = 0
coef(summary(mod))["Seasonwinter:DomD",1] #D in winter, winter C = 0, summer C = 0

# C summer
plot(chltot~Light, data=C.sum.df, col='red3', ylim=c(0, 15), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(chltot~Light, data=D.sum.df, col='blue', ylim=c(0, 15), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=expression(paste("total chlorophyll", ~(mu*g~cm^-2), sep="")), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(chltot~Light, data=C.win.df, col='red3', ylim=c(0, 15), xlim=c(15, 0), yaxt="n", xaxt="n",cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(chltot~Light, data=D.win.df, col='blue', ylim=c(0, 15), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="",
     cex.lab=0.8, cex.axis=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1] + coef(summary(mod))["Seasonwinter:DomD",1]) , coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/physiology/PanKB.chla.pdf", width=6, height=4)
dev.off()
```
  
**Chlorophyll per symbiont cell**
```{r chlorophyll cell figure, results="hide"}
##################
# Fig: chlorophyll/cell over season and depth
##################  
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$chlcell<-log(model.data$chlacell)
mod<-lmer(chlcell~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

##### back transformed
x_light=seq(1,23, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Light",1]*x_light)

# C summer
plot(chlcell~Light, data=C.sum.df, col='red3', ylim=c(0, 15), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
x_light=seq(5,24, 0.5)
ypred= exp(intercept+ coef(summary(mod))["DomD",1]+coef(summary(mod))["Light",1]*x_light)

plot(chlcell~Light, data=D.sum.df, col='blue', ylim=c(0, 15), xlim=c(25, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))), 
     cex.axis=0.8, cex.lab=0.8, main="Summer", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)


# C winter
x_light=seq(0.3,14, 0.5)
ypred= exp(intercept + coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["Light",1]*x_light)

plot(chlcell~Light, data=C.win.df, col='red3', ylim=c(0, 15), xlim=c(15, 0), yaxt="n", xaxt="n",cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)

par(new=T)

# D winter
x_light=seq(1.5,14, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["DomD",1] +
             coef(summary(mod))["Light",1]*x_light)

plot(chlcell~Light, data=D.win.df, col='blue', ylim=c(0, 15), xlim=c(15, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab="",
     cex.axis=0.8, cex.lab=0.8, main="Winter", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)

dev.copy(pdf, "figures/physiology/PanKB.chlacell.pdf", width=6, height=4)
dev.off()

```
   
**Symbiont densities**
```{r symbiont figure, results="hide"}
##################
# Fig: symbionts over season and depth
##################  
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$zoox<-log(model.data$zoox)
mod<-lmer(zoox~Season+Light+Dom+Season:Light + (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params


####################    
##### back transformed
x_light=seq(1,23, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Light",1]*x_light)

# C summer
plot(zoox~Light, data=C.sum.df, col='red3', ylim=c(0, 6000000), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
x_light=seq(5,24, 0.5)
ypred= exp(intercept+ coef(summary(mod))["DomD",1]+coef(summary(mod))["Light",1]*x_light)

plot(zoox~Light, data=D.sum.df, col='blue', ylim=c(0, 6000000), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     cex.axis=0.8, cex.lab=0.8, main="Summer", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)


# C winter
x_light=seq(0.3,14, 0.5)
ypred= exp(intercept + coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["Light",1]+ coef(summary(mod))["Seasonwinter:Light",1]*x_light)

plot(zoox~Light, data=C.win.df, col='red3', ylim=c(0, 6000000), xlim=c(15, 0), yaxt="n", xaxt="n",cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)

par(new=T)

# D winter
x_light=seq(1.5,14, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["Light",1]+ coef(summary(mod))["DomD",1] + coef(summary(mod))["Seasonwinter:Light",1]*x_light)

plot(zoox~Light, data=D.win.df, col='blue', ylim=c(0, 6000000), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab="", cex.axis=0.8,
     cex.axis=0.8, cex.lab=0.8, main="Winter", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)

dev.copy(pdf, "figures/physiology/PanKB.zoox.pdf", width=6, height=4)
dev.off()
```
  
#### Isotopes  
  
**Host tissue carbon isotope composition**
```{r isotopes d13C host figure, results="hide"}
##################
# Fig: d13C host over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$host..d13C
mod<-lmer(host..d13C~Season+Light+Dom+ Season:Dom+ Season:Light+(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(host..d13C~Light, data=C.sum.df, col='red3', ylim=c(-20, -10), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(host..d13C~Light, data=D.sum.df, col='blue', ylim=c(-20, -10), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(host..d13C~Light, data=C.win.df, col='red3', ylim=c(-20, -10), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]),   (coef(summary(mod))["Light",1]+coef(summary(mod))["Seasonwinter:Light",1]), col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(host..d13C~Light, data=D.win.df, col='blue', ylim=c(-20, -10), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]+ coef(summary(mod))["Seasonwinter:DomD",1]), (coef(summary(mod))["Light",1]+coef(summary(mod))["Seasonwinter:Light",1]), 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d13C-host.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
**Symbiont tissue carbon isotope composition**
```{r isotopes d13C symb figure, results="hide"}
##################
# Fig: d13C symb over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$symb..d13C
mod<-lmer(symb..d13C~Season+Light+Dom+ Season:Dom+ Season:Light+(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(symb..d13C~Light, data=C.sum.df, col='red3', ylim=c(-20, -10), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(symb..d13C~Light, data=D.sum.df, col='blue', ylim=c(-20, -10), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(symb..d13C~Light, data=C.win.df, col='red3', ylim=c(-20, -10), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), (coef(summary(mod))["Light",1]+ coef(summary(mod))["Seasonwinter:Light",1]), col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(symb..d13C~Light, data=D.win.df, col='blue', ylim=c(-20, -10), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]+ coef(summary(mod))["Seasonwinter:DomD",1]),
(coef(summary(mod))["Light",1]+coef(summary(mod))["Seasonwinter:Light",1]), col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d13C-symb.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```

**Host-symbiont tissue carbon isotope composition**
```{r isotopes host and symbiont, results="hide"}
##################
# Fig: d13C host-symb over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$d13C..host.sym
mod<-lmer(d13C..host.sym~Season+Light+Dom+ Season:Light +Season:Dom +(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

plot(d13C..host.sym~Dom, data=data.trim)

# C summer
plot(d13C..host.sym~Light, data=C.sum.df, col='red3', ylim=c(-3, 3), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(d13C..host.sym~Light, data=D.sum.df, col='blue', ylim=c(-3, 3), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{13}, C[H-S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(d13C..host.sym~Light, data=C.win.df, col='red3', ylim=c(-3, 3), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), (coef(summary(mod))["Light",1]+coef(summary(mod))["Seasonwinter:Light",1]), col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(d13C..host.sym~Light, data=D.win.df, col='blue', ylim=c(-3, 3), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]+
              coef(summary(mod))["Seasonwinter:DomD",1]),
           (coef(summary(mod))["Light",1]+ coef(summary(mod))["Seasonwinter:Light",1]), 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d13Ch-s.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```

**Coral skeleton tissue carbon isotope composition**
```{r isotopes skeleton, results="hide"}
##################
# Fig: d13C skeleton over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$d13C..skel
mod<-lmer(d13C..skel~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(d13C..skel~Light, data=C.sum.df, col='red3', ylim=c(-8, 4), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(d13C..skel~Light, data=D.sum.df, col='blue', ylim=c(-8, 4), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{13}, C[Sk], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(d13C..skel~Light, data=C.win.df, col='red3', ylim=c(-8, 4), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(d13C..skel~Light, data=D.win.df, col='blue', ylim=c(-8, 4), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]),
       coef(summary(mod))["Light",1], 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d13C-skel.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```


```{r isotopes skeleton C and O, eval=FALSE}
##################
# Fig: d13C skeleton over season and depth
##################        
par(mfrow=c(1,1),mar=c(5,4.5,2,2))

C.skel<-df.fig[df.fig$Dom=="C", ]
D.skel<-df.fig[df.fig$Dom=="D", ]

# df.fig
plot(d18O..skel~d13C..skel, data=C.skel, col='red3', ylim=c(-6, -1), xlim=c(-5, 1), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
par(new=T)

plot(d18O..skel~d13C..skel, data=D.skel, col='blue', ylim=c(-6, -1), xlim=c(-5, 1), cex=0.8, pch=21, bg="deepskyblue1",
     ylab=(expression(paste(delta^{18}, O[Sk], " (\u2030, V-PDB)"))), 
     xlab=(expression(paste(delta^{13}, C[Sk], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
par(new=T)
abline(a=-1.40, b=.33)
ablineclip(-3.84584, 0.08954, col="salmon", 
           x1 = min(C.skel$d13C..skel), x2 = max(C.skel$d13C..skel), lwd=2) # significant for C
ablineclip(-3.19236, 0.31486, col="deepskyblue1", 
           x1 = min(D.skel$d13C..skel), x2 = max(D.skel$d13C..skel), lwd=2) # significant for C

#lm(d18O..skel~d13C..skel, data=C.skel) # significant for C
#lm(d18O..skel~d13C..skel, data=D.skel) # significant for D

# carbon equil at 2.85 permil
# oxygen equil at -1.24 peril for temp range
# if (-1.24, 2.85) on line and slope of 0.33 used at ratio of 1:3 oxygen : carbon, then y intercept is -1.40

# C summer
plot(d13C..skel~Light, data=C.sum.df, col='red3', ylim=c(-8, 4), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(d13C..skel~Light, data=D.sum.df, col='blue', ylim=c(-8, 4), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{13}, C[Sk], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(d13C..skel~Light, data=C.win.df, col='red3', ylim=c(-8, 4), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(d13C..skel~Light, data=D.win.df, col='blue', ylim=c(-8, 4), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]),
       coef(summary(mod))["Light",1], 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d13C-skel.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```


**Host tissue nitrogen isotope composition**
```{r isotopes host nitrogen, results="hide"}
##################
# Fig: d15N host over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$host..d15N
mod<-lmer(host..d15N~Season+Light+Dom+(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(host..d15N~Light, data=C.sum.df, col='red3', ylim=c(2, 8), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(host..d15N~Light, data=D.sum.df, col='blue', ylim=c(2, 8), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(host..d15N~Light, data=C.win.df, col='red3', ylim=c(2, 8), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(host..d15N~Light, data=D.win.df, col='blue', ylim=c(2, 8), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]),
           coef(summary(mod))["Light",1], 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d15N-host.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
  
**Symbiont tissue nitrogen isotope composition**
```{r isotopes symb nitrogen, results="hide"}
##################
# Fig: d15N symb over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$symb..d15N
mod<-lmer(symb..d15N~Season+Light+Dom+ Season:Dom +(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(symb..d15N~Light, data=C.sum.df, col='red3', ylim=c(2, 8), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(symb..d15N~Light, data=D.sum.df, col='blue', ylim=c(2, 8), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), 
           (coef(summary(mod))["Light",1]), col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(symb..d15N~Light, data=C.win.df, col='red3', ylim=c(2, 8), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(symb..d15N~Light, data=D.win.df, col='blue', ylim=c(2, 8), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]+
              coef(summary(mod))["Seasonwinter:DomD",1]),
           (coef(summary(mod))["Light",1]), 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.d15N-symb.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
  
**Host-symbiont tissue nitrogen isotope composition**
```{r isotopes host symb N, results="hide"}
##################
# Fig: d15N host.symb over season and depth
##################        
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# model.data$d15N..host.sym
mod<-lmer(d15N..host.sym~Season+Light+Dom+ Season:Dom +(1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

# C summer
plot(d15N..host.sym~Light, data=C.sum.df, col='red3', ylim=c(-1,2), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Summer", cex.main=0.7)
ablineclip(intercept, coef(summary(mod))["Light",1], col="salmon", 
           x1 = min(C.sum.df$Light), x2 = max(C.sum.df$Light), lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
plot(d15N..host.sym~Light, data=D.sum.df, col='blue', ylim=c(-1,2), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste(delta^{15}, N[H-S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["DomD",1]), 
           coef(summary(mod))["Light",1], col="deepskyblue1", x1 = min(D.sum.df$Light), x2 = max(D.sum.df$Light), lwd=2)

# C winter
plot(d15N..host.sym~Light, data=C.win.df, col='red3', ylim=c(-1,2), xlim=c(15, 0), yaxt="n", xaxt="n",
     cex=0.8, pch=21, bg="salmon", ylab="", xlab ="", main="Winter", cex.main=0.7)
ablineclip((intercept + coef(summary(mod))["Seasonwinter",1]), coef(summary(mod))["Light",1], col="salmon", x1 = min(C.win.df$Light), x2 = max(C.win.df$Light), lwd=2)
par(new=T)

# D winter
plot(d15N..host.sym~Light, data=D.win.df, col='blue', ylim=c(-1,2), xlim=c(15, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab="", cex.axis=0.8, cex.lab=0.8)
ablineclip((intercept+ coef(summary(mod))["Seasonwinter",1]+ coef(summary(mod))["DomD",1]+
              coef(summary(mod))["Seasonwinter:DomD",1]),
           coef(summary(mod))["Light",1], 
      col="deepskyblue1", x1 = min(D.win.df$Light), x2 = max(D.win.df$Light), lwd=2)


dev.copy(pdf, "figures/isotope/PanKB.d15Nh-s.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```


**Host tissue C:N**
```{r isotopes host  CN, results="hide"}
##################
# Fig: C.N host season and depth
##################       
      
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# log(model.data$host..C.N)
mod<-lmer(host..C.N~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

##### back transformed
x_light=seq(1,23, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Light",1]*x_light)

# C summer
plot(host..C.N~Light, data=C.sum.df, col='red3', ylim=c(5, 12), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
x_light=seq(5,24, 0.5)
ypred= exp(intercept+ coef(summary(mod))["DomD",1]+coef(summary(mod))["Light",1]*x_light)

plot(host..C.N~Light, data=D.sum.df, col='blue', ylim=c(5, 12), xlim=c(25, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab=(expression(paste("C:N"[H]), sep="")), 
     cex.axis=0.8, cex.lab=0.8, main="Summer", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)


# C winter
x_light=seq(0.3,14, 0.5)
ypred= exp(intercept + coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["Light",1]*x_light)

plot(host..C.N~Light, data=C.win.df, col='red3', ylim=c(5, 12), xlim=c(15, 0), yaxt="n", xaxt="n",cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)

par(new=T)

# D winter
x_light=seq(1.5,14, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["DomD",1] +
             coef(summary(mod))["Light",1]*x_light)

plot(host..C.N~Light, data=D.win.df, col='blue', ylim=c(5, 12), xlim=c(15, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab="",
     cex.axis=0.8, cex.lab=0.8, main="Winter", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.C.Nhost.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
  
**Symbiont tissue C:N**
```{r isotopes symb CN, results="hide"}
##################
# Fig: C.N symb season and depth
##################       
      
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# log(model.data$host..C.N)
mod<-lmer(symb..C.N~Season+Light+Dom+ (1|Location), data=model.data, na.action=na.exclude)
intercept<-coef(summary(mod))[1] # intercept
fixed_params <- tidy_lmer(mod, effects = "fixed")[,c("term", "estimate")]; fixed_params

##### back transformed
x_light=seq(1,23, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Light",1]*x_light)

# C summer
plot(symb..C.N~Light, data=C.sum.df, col='red3', ylim=c(5, 12), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
par(new=T)

# D summer
x_light=seq(5,24, 0.5)
ypred= exp(intercept+ coef(summary(mod))["DomD",1]+coef(summary(mod))["Light",1]*x_light)

plot(symb..C.N~Light, data=D.sum.df, col='blue', ylim=c(5, 12), xlim=c(25, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab=(expression(paste("C:N"[S]), sep="")), 
     cex.axis=0.8, cex.lab=0.8, main="Summer", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)


# C winter
x_light=seq(0.3,14, 0.5)
ypred= exp(intercept + coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["Light",1]*x_light)

plot(symb..C.N~Light, data=C.win.df, col='red3', ylim=c(5, 12), xlim=c(15, 0), yaxt="n", xaxt="n",cex=0.8,
     pch=21, bg="salmon", ylab="", xlab ="")
lines(x_light, ypred, col="salmon", lwd=2)

par(new=T)

# D winter
x_light=seq(1.5,14, 0.5)
ypred= exp(intercept+ coef(summary(mod))["Seasonwinter",1] + coef(summary(mod))["DomD",1] +
             coef(summary(mod))["Light",1]*x_light)

plot(symb..C.N~Light, data=D.win.df, col='blue', ylim=c(5, 12), xlim=c(15, 0), cex=0.8, pch=21,
     bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))),
     ylab="",
     cex.axis=0.8, cex.lab=0.8, main="Winter", cex.main=0.7)
lines(x_light, ypred, col="deepskyblue1", lwd=2)

dev.copy(pdf, "figures/isotope/PanKB.C.Nsym.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
  
Changes in **host C and N isotope values** show significant relationships, with *significant relationships for C (summer and winter, p < 0.016) and D (summer, p =0.035) symbionts*. No significant relationship for clade D in the winter was observed.
  
Changes in **symbiont C and N isotope values** were significant: in the *winter for clade C (p=0.026) summer for clade D (p=0.021)*.  Clade C in the summer and D in the winter were not significant.
  
Together this shows a significant relationship between carbon and nitrogen isotope values in clade D host and symbiont tissues during summer months, whereas the this relationship in clade C  changes in both summer and winter (host only) and symbionts in the winter corals.
  

```{r C and N isotope scatter host, results="hide", fig.align='center'}
par(mfrow=c(1,4),mar=c(5,4.5,2,0.5))

summary(lm(host..d15N~host..d13C, data=C.sum.df)) # SIGNIF p=0.016
summary(lm(host..d15N~host..d13C, data=D.sum.df)) # SIGNIF p=0.035
summary(lm(host..d15N~host..d13C, data=C.win.df)) # SIGNIF p=0.004
summary(lm(host..d15N~host..d13C, data=D.win.df)) # not significant

# C summer plot
plot(host..d15N~host..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", main="Summer--host", cex.main=0.7, xaxt="n",
     ylab=(expression(paste(delta^{15}, N, " (\u2030, Air)"))),
     xlab=(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.9,
       y.intersp = 1.2, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.9, y.intersp = 1.2, x.intersp = 0.4, bty="n", inset=c(0.49, 0))
ablineclip(lm(host..d15N~host..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d13C), x2 = max(C.sum.df$host..d13C), lwd=2)

# D summer plot
par(new=T)
plot(host..d15N~host..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(host..d15N~host..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d13C), x2 = max(D.sum.df$host..d13C), lwd=2)

# C winter plot
plot(host..d15N~host..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter--host", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(host..d15N~host..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d13C), x2 = max(C.win.df$host..d13C), lwd=2)

# D winter plot
par(new=T)
plot(host..d15N~host..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(host..d15N~host..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d13C), x2 = max(D.win.df$host..d13C), lwd=2)

#### r C and N isotope scatter symb

summary(lm(symb..d15N~symb..d13C, data=C.sum.df)) # not significant
summary(lm(symb..d15N~symb..d13C, data=D.sum.df)) # SIGNIF p=0.021
summary(lm(symb..d15N~symb..d13C, data=C.win.df)) # SIGNIF p=0.026
summary(lm(symb..d15N~symb..d13C, data=D.win.df)) # not significant

# C summer plot
plot(symb..d15N~symb..d13C, data=C.sum.df, col='palevioletred4', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="palevioletred2", main="Summer--symbiont", cex.main=0.7, ylab="", yaxt="n", xaxt="n",
     xlab=(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("palevioletred3", "lightskyblue3"),
       cex=0.9, y.intersp = 1.2, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("palevioletred2", "lightskyblue2"), col=c("palevioletred4", "lightskyblue4"), cex=0.9, y.intersp = 1.2, x.intersp = 0.4, bty="n", 
       inset=c(0.49, 0))
ablineclip(lm(symb..d15N~symb..d13C, data=C.sum.df), col='palevioletred2', x1 = min(C.sum.df$symb..d13C), x2 = max(C.sum.df$symb..d13C), lwd=2)

# D summer plot
par(new=T)
plot(symb..d15N~symb..d13C, data=D.sum.df, col='lightskyblue4', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="lightskyblue2", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
Axis(side=2, labels=FALSE)
ablineclip(lm(symb..d15N~symb..d13C, data=D.sum.df), col='lightskyblue3', x1 = min(D.sum.df$symb..d13C), x2 = max(D.sum.df$symb..d13C), lwd=2)

# C winter plot
plot(symb..d15N~symb..d13C, data=C.win.df, col='palevioletred4', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="palevioletred2", xaxt="n", yaxt="n", ylab="", xlab ="", main="Winter--symbiont", cex.main=0.7)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
ablineclip(lm(symb..d15N~symb..d13C, data=C.win.df), col='palevioletred2', x1 = min(C.win.df$symb..d13C), x2 = max(C.win.df$symb..d13C), lwd=2)

# D winter plot
par(new=T)
plot(symb..d15N~symb..d13C, data=D.win.df, col='lightskyblue4', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="lightskyblue2", ylab="", xaxt="n", yaxt="n", cex.main=0.7,
xlab=(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(symb..d15N~symb..d13C, data=D.win.df), col='lightskyblue3', x1 = min(D.win.df$symb..d13C), x2 = max(D.win.df$symb..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.CN.scat.pdf", width=7, height=3, encod="MacRoman")
dev.off()
```

```{r C and N isotope scatter depth, results="hide", fig.align='center'}
      
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

shallow.sum<-df.fig[df.fig$depth.bin.small=="<4m" & df.fig$Season=="summer", ]
deep.sum<-df.fig[df.fig$depth.bin.small==">4m" & df.fig$Season=="summer",]

shallow.wint<-df.fig[df.fig$depth.bin.small=="<4m" & df.fig$Season=="winter", ]
deep.wint<-df.fig[df.fig$depth.bin.small==">4m" & df.fig$Season=="winter",]


####### hosts
### shallow summer
plot(host..d15N~host..d13C, data=shallow.sum, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))),
     xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c(" < 4m", " > 4m"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.31, 0))
ablineclip(lm(host..d15N~host..d13C, data=shallow.sum), col='salmon', x1 = min(shallow.sum$host..d13C), x2 = max(shallow.sum$host..d13C), lwd=2)

# deep summer
par(new=T)
plot(host..d15N~host..d13C, data=deep.sum, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(host..d15N~host..d13C, data=deep.sum), col='deepskyblue1', x1 = min(deep.sum$host..d13C), x2 = max(deep.sum$host..d13C), lwd=2)


### shallow winter
plot(host..d15N~host..d13C, data=shallow.wint, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", main="Winter", cex.main=0.7, xaxt="n", ylab="",
     xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c(" < 4m", " > 4m"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.31, 0))
ablineclip(lm(host..d15N~host..d13C, data=shallow.wint), col='salmon', x1 = min(shallow.wint$host..d13C), x2 = max(shallow.wint$host..d13C), lwd=2)

# deep winter
par(new=T)
plot(host..d15N~host..d13C, data=deep.wint, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(host..d15N~host..d13C, data=deep.wint), col='deepskyblue1', x1 = min(deep.wint$host..d13C), x2 = max(deep.wint$host..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.scatdepth.host.pdf", width=6, height=4, encod="MacRoman")
dev.off()


#### symbionts

### shallow summer
plot(symb..d15N~symb..d13C, data=shallow.sum, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))),
     xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c(" < 4m", " > 4m"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.31, 0))
ablineclip(lm(symb..d15N~symb..d13C, data=shallow.sum), col='salmon', x1 = min(shallow.sum$symb..d13C), x2 = max(shallow.sum$symb..d13C), lwd=2)

# deep summer
par(new=T)
plot(symb..d15N~symb..d13C, data=deep.sum, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(symb..d15N~symb..d13C, data=deep.sum), col='deepskyblue1', x1 = min(deep.sum$symb..d13C), x2 = max(deep.sum$symb..d13C), lwd=2)


### shallow winter
plot(symb..d15N~symb..d13C, data=shallow.wint, col='red3', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="salmon", main="Winter", cex.main=0.7, xaxt="n", ylab="",
     xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c(" < 4m", "> 4m"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.31, 0))
ablineclip(lm(symb..d15N~symb..d13C, data=shallow.wint), col='salmon', x1 = min(shallow.wint$symb..d13C), x2 = max(shallow.wint$symb..d13C), lwd=2)

# deep winter
par(new=T)
plot(symb..d15N~symb..d13C, data=deep.wint, col='blue', xlim=c(-20, -12), ylim=c(2.5, 6.5), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(symb..d15N~symb..d13C, data=deep.wint), col='deepskyblue1', x1 = min(deep.wint$symb..d13C), x2 = max(deep.wint$symb..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.scatdepth.symb.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
*What is driving differences in d13C?*
Plot relationship between chlorophyll, chlorophyll per cell, and zoox in relation to d13C 
  
- *In the host*:zoox density in *winter* (C and D corals) positively relates with d13C values. In clade C corals, chl/cell influences d13C values in summer and shows near significant values in winter.
  
- *In the symbiont*: we see similar patterns. In winter, d13C in clade C and D corals are influenced by zoox density. In both seasons for clade C corals, chl/cell also influences d13C values.  

- *In host-symbiont*: we also see that symbiont density relates to host-symb d13C. In winter, C and D corals show a relationship, but only D corals in the summer

```{r d13C scatter with host and symbiont physiology, results="hide", fig.align='center'}
### IN THE HOST ###

##### clade C
# ZOOX in the winter influence d13C
# CHLCELL in summer influences d13C

summary(lm(zoox~host..d13C, data=C.sum.df)) # NS
summary(lm(zoox~host..d13C, data=C.win.df)) # signif p=0.0001

summary(lm(chltot~host..d13C, data=C.sum.df)) # NS
summary(lm(chltot~host..d13C, data=C.win.df)) # NS

summary(lm(chlcell~host..d13C, data=C.sum.df)) # signif p = 0.024
summary(lm(chlcell~host..d13C, data=C.win.df)) # almost p=0.059


#### clade D
# ZOOX in winter influence d13C

summary(lm(zoox~host..d13C, data=D.sum.df)) # NS
summary(lm(zoox~host..d13C, data=D.win.df)) # signif p=0.030

summary(lm(chltot~host..d13C, data=D.sum.df)) # NS
summary(lm(chltot~host..d13C, data=D.win.df)) # NS

summary(lm(chlcell~host..d13C, data=D.sum.df)) # NS 
summary(lm(chlcell~host..d13C, data=D.win.df)) # NS


### IN THE SYMBIONT ###

##### clade C
# ZOOX in the winter influence d13C
# CHLCELL in summer and winter influences d13C

summary(lm(zoox~symb..d13C, data=C.sum.df)) # NS
summary(lm(zoox~symb..d13C, data=C.win.df)) # signif p<0.0001

summary(lm(chltot~symb..d13C, data=C.sum.df)) # NS
summary(lm(chltot~symb..d13C, data=C.win.df)) # NS

summary(lm(chlcell~symb..d13C, data=C.sum.df)) # signif p=0.004
summary(lm(chlcell~symb..d13C, data=C.win.df)) # signif p=0.030


#### clade D
# ZOOX in winter influence d13C

summary(lm(zoox~symb..d13C, data=D.win.df)) # signif p=0.007
summary(lm(zoox~symb..d13C, data=D.sum.df)) # NS

summary(lm(chltot~symb..d13C, data=D.win.df)) # NS
summary(lm(chltot~symb..d13C, data=D.sum.df)) # NS

summary(lm(chlcell~symb..d13C, data=D.win.df)) # NS
summary(lm(chlcell~symb..d13C, data=D.sum.df)) # NS 


##### IN HOST-SYMBIONT
## zoox
summary(lm(zoox~d13C..host.sym, data=C.sum.df)) # NS
summary(lm(zoox~d13C..host.sym, data=C.win.df)) # signif p=0.014
summary(lm(zoox~d13C..host.sym, data=D.sum.df)) # signif p=0.004
summary(lm(zoox~d13C..host.sym, data=D.win.df)) # signif p=0.007


############################
######### symbionts cm-2 and d13C

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~host..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(zoox~host..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d13C), x2 = max(C.sum.df$host..d13C), lwd=2)

# D summer plot
par(new=T)
plot(zoox~host..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~host..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d13C), x2 = max(D.sum.df$host..d13C), lwd=2)

# C winter plot
plot(zoox~host..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~host..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d13C), x2 = max(C.win.df$host..d13C), lwd=2)

# D winter plot
par(new=T)
plot(zoox~host..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~host..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d13C), x2 = max(D.win.df$host..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d13Chost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~symb..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(zoox~symb..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d13C), x2 = max(C.sum.df$symb..d13C), lwd=2)

# D summer plot
par(new=T)
plot(zoox~symb..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~symb..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d13C), x2 = max(D.sum.df$symb..d13C), lwd=2)

# C winter plot
plot(zoox~symb..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~symb..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d13C), x2 = max(C.win.df$symb..d13C), lwd=2)

# D winter plot
par(new=T)
plot(zoox~symb..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~symb..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d13C), x2 = max(D.win.df$symb..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d13Csymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()



############################
######### total chlorophyll a cm-2 and d13C

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chltot~host..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("total chlorophyll", ~(mu*g~cm^-2), sep="")),
     xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chltot~host..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d13C), x2 = max(C.sum.df$host..d13C), lwd=2)

# D summer plot
par(new=T)
plot(chltot~host..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~host..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d13C), x2 = max(D.sum.df$host..d13C), lwd=2)

# C winter plot
plot(chltot~host..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~host..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d13C), x2 = max(C.win.df$host..d13C), lwd=2)

# D winter plot
par(new=T)
plot(chltot~host..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chltot~host..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d13C), x2 = max(D.win.df$host..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chltot.d13Chost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chltot~symb..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("total chlorophyll", ~(mu*g~cm^-2), sep="")),
     xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chltot~symb..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d13C), x2 = max(C.sum.df$symb..d13C), lwd=2)

# D summer plot
par(new=T)
plot(chltot~symb..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~symb..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d13C), x2 = max(D.sum.df$symb..d13C), lwd=2)

# C winter plot
plot(chltot~symb..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~symb..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d13C), x2 = max(C.win.df$symb..d13C), lwd=2)

# D winter plot
par(new=T)
plot(chltot~symb..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chltot~symb..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d13C), x2 = max(D.win.df$symb..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chltot.d13Csymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()


############################
######### chlorophyll a cell-1 and d13C

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chlcell~host..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),
     xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chlcell~host..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d13C), x2 = max(C.sum.df$host..d13C), lwd=2)

# D summer plot
par(new=T)
plot(chlcell~host..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~host..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d13C), x2 = max(D.sum.df$host..d13C), lwd=2)

# C winter plot
plot(chlcell~host..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~host..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d13C), x2 = max(C.win.df$host..d13C), lwd=2)

# D winter plot
par(new=T)
plot(chlcell~host..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chlcell~host..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d13C), x2 = max(D.win.df$host..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chlcell.d13Chost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chlcell~symb..d13C, data=C.sum.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),
     xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chlcell~symb..d13C, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d13C), x2 = max(C.sum.df$symb..d13C), lwd=2)

# D summer plot
par(new=T)
plot(chlcell~symb..d13C, data=D.sum.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~symb..d13C, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d13C), x2 = max(D.sum.df$symb..d13C), lwd=2)

# C winter plot
plot(chlcell~symb..d13C, data=C.win.df, col='red3', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~symb..d13C, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d13C), x2 = max(C.win.df$symb..d13C), lwd=2)

# D winter plot
par(new=T)
plot(chlcell~symb..d13C, data=D.win.df, col='blue', xlim=c(-20, -12), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-20, -12, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chlcell~symb..d13C, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d13C), x2 = max(D.win.df$symb..d13C), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chlcell.d13Csymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()

############################
######### zoox cm-2 and d13Ch-s

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~d13C..host.sym, data=C.sum.df, col='red3', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{13}, C[H-S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-2, 2, by = 1), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.35, 0))
ablineclip(lm(zoox~d13C..host.sym, data=C.sum.df), col='salmon', 
           x1 = min(C.sum.df$d13C..host.sym), x2 = max(C.sum.df$d13C..host.sym), lwd=2)

# D summer plot
par(new=T)
plot(zoox~d13C..host.sym, data=D.sum.df, col='blue', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~d13C..host.sym, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$d13C..host.sym), x2 = max(D.sum.df$d13C..host.sym), lwd=2)

# C winter plot
plot(zoox~d13C..host.sym, data=C.win.df, col='red3', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~d13C..host.sym, data=C.win.df), col='salmon', x1 = min(C.win.df$d13C..host.sym), x2 = max(C.win.df$d13C..host.sym), lwd=2)

# D winter plot
par(new=T)
plot(zoox~d13C..host.sym, data=D.win.df, col='blue', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{13}, C[H-S], " (\u2030, V-PDB)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-2, 2, by = 1), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~d13C..host.sym, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$d13C..host.sym), x2 = max(D.win.df$d13C..host.sym), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d13Chs.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  

```{r d15N scatter with host and symbiont physiology, results="hide", fig.align='center', eval=FALSE}
#Looking at d15N now...

### IN THE HOST ###

##### clade C
# ZOOX in the winter influence d15N
# CHLCELL in summer influences d15N

summary(lm(zoox~host..d15N, data=C.sum.df)) # NS
summary(lm(zoox~host..d15N, data=C.win.df)) # NS

summary(lm(chltot~host..d15N, data=C.sum.df)) # NS
summary(lm(chltot~host..d15N, data=C.win.df)) # NS

summary(lm(chlcell~host..d15N, data=C.sum.df)) # NS
summary(lm(chlcell~host..d15N, data=C.win.df)) # NS


#### clade D
# ZOOX in winter influence d15N

summary(lm(zoox~host..d15N, data=D.sum.df)) # NS
summary(lm(zoox~host..d15N, data=D.win.df)) # NS

summary(lm(chltot~host..d15N, data=D.sum.df)) # NS
summary(lm(chltot~host..d15N, data=D.win.df)) # NS

summary(lm(chlcell~host..d15N, data=D.sum.df)) # NS 
summary(lm(chlcell~host..d15N, data=D.win.df)) # NS


### IN THE SYMBIONT ###

##### clade C
# ZOOX in the winter influence d15N
# CHLCELL in summer and winter influences d15N

summary(lm(zoox~symb..d15N, data=C.sum.df)) # NS
summary(lm(zoox~symb..d15N, data=C.win.df)) # NS

summary(lm(chltot~symb..d15N, data=C.sum.df)) # NS
summary(lm(chltot~symb..d15N, data=C.win.df)) # NS

summary(lm(chlcell~symb..d15N, data=C.sum.df)) # signif p=0.028
summary(lm(chlcell~symb..d15N, data=C.win.df)) # NS


#### clade D
# ZOOX in winter influence d15N

summary(lm(zoox~symb..d15N, data=D.win.df)) # NS
summary(lm(zoox~symb..d15N, data=D.sum.df)) # NS

summary(lm(chltot~symb..d15N, data=D.win.df)) # NS
summary(lm(chltot~symb..d15N, data=D.sum.df)) # NS

summary(lm(chlcell~symb..d15N, data=D.win.df)) # NS
summary(lm(chlcell~symb..d15N, data=D.sum.df)) # NS 


##### IN HOST-SYMBIONT
## zoox
summary(lm(zoox~d15N..host.sym, data=C.sum.df)) # NS
summary(lm(zoox~d15N..host.sym, data=C.win.df)) # NS
summary(lm(zoox~d15N..host.sym, data=D.sum.df)) # NS
summary(lm(zoox~d15N..host.sym, data=D.win.df)) # NS


############################
######### symbionts cm-2 and d15N

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~host..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(zoox~host..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d15N), x2 = max(C.sum.df$host..d15N), lwd=2)

# D summer plot
par(new=T)
plot(zoox~host..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~host..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d15N), x2 = max(D.sum.df$host..d15N), lwd=2)

# C winter plot
plot(zoox~host..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~host..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d15N), x2 = max(C.win.df$host..d15N), lwd=2)

# D winter plot
par(new=T)
plot(zoox~host..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~host..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d15N), x2 = max(D.win.df$host..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d15Nhost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~symb..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(zoox~symb..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d15N), x2 = max(C.sum.df$symb..d15N), lwd=2)

# D summer plot
par(new=T)
plot(zoox~symb..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~symb..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d15N), x2 = max(D.sum.df$symb..d15N), lwd=2)

# C winter plot
plot(zoox~symb..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~symb..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d15N), x2 = max(C.win.df$symb..d15N), lwd=2)

# D winter plot
par(new=T)
plot(zoox~symb..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~symb..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d15N), x2 = max(D.win.df$symb..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d15Nsymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()



############################
######### total chlorophyll a cm-2 and d15N

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chltot~host..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("total chlorophyll", ~(mu*g~cm^-2), sep="")),
     xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chltot~host..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d15N), x2 = max(C.sum.df$host..d15N), lwd=2)

# D summer plot
par(new=T)
plot(chltot~host..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~host..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d15N), x2 = max(D.sum.df$host..d15N), lwd=2)

# C winter plot
plot(chltot~host..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~host..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d15N), x2 = max(C.win.df$host..d15N), lwd=2)

# D winter plot
par(new=T)
plot(chltot~host..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chltot~host..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d15N), x2 = max(D.win.df$host..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chltot.d15Nhost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chltot~symb..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("total chlorophyll", ~(mu*g~cm^-2), sep="")),
     xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chltot~symb..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d15N), x2 = max(C.sum.df$symb..d15N), lwd=2)

# D summer plot
par(new=T)
plot(chltot~symb..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~symb..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d15N), x2 = max(D.sum.df$symb..d15N), lwd=2)

# C winter plot
plot(chltot~symb..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chltot~symb..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d15N), x2 = max(C.win.df$symb..d15N), lwd=2)

# D winter plot
par(new=T)
plot(chltot~symb..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chltot~symb..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d15N), x2 = max(D.win.df$symb..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chltot.d15Nsymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()


############################
######### chlorophyll a cell-1 and d15N

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chlcell~host..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),
     xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chlcell~host..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$host..d15N), x2 = max(C.sum.df$host..d15N), lwd=2)

# D summer plot
par(new=T)
plot(chlcell~host..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~host..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$host..d15N), x2 = max(D.sum.df$host..d15N), lwd=2)

# C winter plot
plot(chlcell~host..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~host..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$host..d15N), x2 = max(C.win.df$host..d15N), lwd=2)

# D winter plot
par(new=T)
plot(chlcell~host..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[H], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chlcell~host..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$host..d15N), x2 = max(D.win.df$host..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chlcell.d15Nhost.pdf", width=6, height=4, encod="MacRoman")
dev.off()


####################
##### Plot it
##### symbiont
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(chlcell~symb..d15N, data=C.sum.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),
     xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
ablineclip(lm(chlcell~symb..d15N, data=C.sum.df), col='salmon', x1 = min(C.sum.df$symb..d15N), x2 = max(C.sum.df$symb..d15N), lwd=2)

# D summer plot
par(new=T)
plot(chlcell~symb..d15N, data=D.sum.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~symb..d15N, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$symb..d15N), x2 = max(D.sum.df$symb..d15N), lwd=2)

# C winter plot
plot(chlcell~symb..d15N, data=C.win.df, col='red3', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(chlcell~symb..d15N, data=C.win.df), col='salmon', x1 = min(C.win.df$symb..d15N), x2 = max(C.win.df$symb..d15N), lwd=2)

# D winter plot
par(new=T)
plot(chlcell~symb..d15N, data=D.win.df, col='blue', xlim=c(2, 8), ylim=c(0, 12), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(2, 8, by = 2), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(chlcell~symb..d15N, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$symb..d15N), x2 = max(D.win.df$symb..d15N), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.chlcell.d15Nsymb.pdf", width=6, height=4, encod="MacRoman")
dev.off()

############################
######### zoox cm-2 and d15Nh-s

##### Plot it
##### host
par(mfrow=c(1,2),mar=c(5,4.5,2,2))

# C summer plot
plot(zoox~d15N..host.sym, data=C.sum.df, col='red3', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", main="Summer", cex.main=0.7, xaxt="n",
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     xlab=(expression(paste(delta^{15}, N[H-S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-2, 2, by = 1), cex.axis=0.8)
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.35, 0))
ablineclip(lm(zoox~d15N..host.sym, data=C.sum.df), col='salmon', 
           x1 = min(C.sum.df$d15N..host.sym), x2 = max(C.sum.df$d15N..host.sym), lwd=2)

# D summer plot
par(new=T)
plot(zoox~d15N..host.sym, data=D.sum.df, col='blue', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", xaxt="n", yaxt="n", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~d15N..host.sym, data=D.sum.df), col='deepskyblue1', x1 = min(D.sum.df$d15N..host.sym), x2 = max(D.sum.df$d15N..host.sym), lwd=2)

# C winter plot
plot(zoox~d15N..host.sym, data=C.win.df, col='red3', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="salmon", xaxt="n", yaxt="n", main="Winter", ylab="", xlab ="", cex.main=0.7)
ablineclip(lm(zoox~d15N..host.sym, data=C.win.df), col='salmon', x1 = min(C.win.df$d15N..host.sym), x2 = max(C.win.df$d15N..host.sym), lwd=2)

# D winter plot
par(new=T)
plot(zoox~d15N..host.sym, data=D.win.df, col='blue', xlim=c(-2, 2), ylim=c(0, 6000000), cex=0.7, pch=21, bg="deepskyblue1", ylab="", cex.main=0.7, yaxt="n", xaxt="n",
xlab=(expression(paste(delta^{15}, N[H-S], " (\u2030, Air)"))), cex.axis=0.8,
     cex.lab=0.8)
Axis(side=1, at = seq(-2, 2, by = 1), cex.axis=0.8)
Axis(side=2, labels=FALSE)
ablineclip(lm(zoox~d15N..host.sym, data=D.win.df), col='deepskyblue1', x1 = min(D.win.df$d15N..host.sym), x2 = max(D.win.df$d15N..host.sym), lwd=2)

dev.copy(pdf, "figures/regressions/PanKB.zoox.d15Nhs.pdf", width=6, height=4, encod="MacRoman")
dev.off()
```
  
  
```{r photoacclimation}
#### Pooled across seasons what is light effect overall for each symbiont species

par(mfrow=c(1,2),mar=c(5,4.5,2,2))

test.dat<-data.trim[,c(17, 1:5, 18:25, 7:16, 26:29)]
C.test.dat<-test.dat[(test.dat$Dom=="C"),]
D.test.dat<-test.dat[(test.dat$Dom=="D"),]

######## by Light
# C 
plot(zoox~Light, data=C.test.dat, col='red3', ylim=c(0, 6000000), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(zoox~Light, data=C.test.dat), col="red")
par(new=T)

# D 
plot(zoox~Light, data=D.test.dat, col='blue', ylim=c(0, 6000000), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     cex.axis=0.8, cex.lab=0.8, main="by Light", cex.main=0.7)
abline(lm(zoox~Light, data=D.test.dat), col="blue")



######## by Depth

# C 
plot(zoox~newDepth, data=C.test.dat, col='red3', ylim=c(0, 6000000), xlim=c(0, 10), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(zoox~newDepth, data=C.test.dat), col="red")
par(new=T)

# D 
plot(zoox~newDepth, data=D.test.dat, col='blue', ylim=c(0, 6000000), xlim=c(0, 10), cex=0.8, pch=21, bg="deepskyblue1",
     xlab="depth (m)", 
     ylab=expression(paste("symbionts ", "(",cells~cm^-2~")", sep="")), 
     cex.axis=0.8, cex.lab=0.8, main="by Depth", cex.main=0.7)
abline(lm(zoox~newDepth, data=D.test.dat), col="blue")

######
###### chla per symbiont 
######## by Light
# C 
plot(chlcell~Light, data=C.test.dat, col='red3', ylim=c(0, 15), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(chlcell~Light, data=C.test.dat), col="red")
par(new=T)

# D 
plot(chlcell~Light, data=D.test.dat, col='blue', ylim=c(0, 15), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),  
     cex.axis=0.8, cex.lab=0.8, main="by Light", cex.main=0.7)
abline(lm(chlcell~Light, data=D.test.dat), col="blue")


######## by Depth

# C 
plot(chlcell~newDepth, data=C.test.dat, col='red3', ylim=c(0, 15), xlim=c(0, 10), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(chlcell~newDepth, data=C.test.dat), col="red")
par(new=T)

# D 
plot(chlcell~newDepth, data=D.test.dat, col='blue', ylim=c(0, 15), xlim=c(0, 10), cex=0.8, pch=21, bg="deepskyblue1",
     xlab="depth (m)", 
     ylab=(expression(paste("chlorophyll (",pg~cell^-1, ")", sep=""))),  
     cex.axis=0.8, cex.lab=0.8, main="by Depth", cex.main=0.7)
abline(lm(chlcell~newDepth, data=D.test.dat), col="blue")

######
###### chla total 
######## by Light
# C 
plot(chltot~Light, data=C.test.dat, col='red3', ylim=c(0, 15), xlim=c(25, 0), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(chltot~Light, data=C.test.dat), col="red")
par(new=T)

# D 
plot(chltot~Light, data=D.test.dat, col='blue', ylim=c(0, 15), xlim=c(25, 0), cex=0.8, pch=21, bg="deepskyblue1",
     xlab=(expression(paste("DLI (mol photons", ~m^-2, ~d^-1,")", sep=""))), 
     ylab=(expression(paste("chlorophyll (",mu,g~cm^-2, ")", sep=""))),  
     cex.axis=0.8, cex.lab=0.8, main="by Light", cex.main=0.7)
abline(lm(chltot~Light, data=D.test.dat), col="blue")


######## by Depth

# C 
plot(chltot~newDepth, data=C.test.dat, col='red3', ylim=c(0, 15), xlim=c(0, 10), yaxt="n", xaxt="n", cex=0.8, pch=21, bg="salmon", ylab="", xlab ="")
legend("topright", c("clade C", "clade D"), lty=c(1,1), lwd=c(2,2), col=c("salmon", "deepskyblue1"), cex=0.8,
       y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.1, 0))
legend("topright", c("", ""), pch=c(21,21), pt.bg=c("salmon", "deepskyblue1"), col=c("red3", "blue"), cex=0.8, y.intersp = 0.9, x.intersp = 0.4, bty="n", inset=c(0.355, 0))
abline(lm(chltot~newDepth, data=C.test.dat), col="red")
par(new=T)

# D 
plot(chltot~newDepth, data=D.test.dat, col='blue', ylim=c(0, 15), xlim=c(0, 10), cex=0.8, pch=21, bg="deepskyblue1",
     xlab="depth (m)", 
     ylab=(expression(paste("chlorophyll (",mu,g~cm^-2, ")", sep=""))),   
     cex.axis=0.8, cex.lab=0.8, main="by Depth", cex.main=0.7)
abline(lm(chltot~newDepth, data=D.test.dat), col="blue")

```


```{r more data exploration with depth and phys by light, eval=FALSE}

#Create a function to generate a continuous color palette
Pal <- colorRampPalette(c('gray80','gray30'))

#This adds a column of color values
# based on the y values

### one approach here
df.fig$Col <- Pal(10)[as.numeric(cut(df.fig$Light,breaks = 20))]

# plot(zoox~host..d13C, data=df.fig, pch = 20,col = df.fig$Col)


p1<-ggplot(df.fig, aes(x=host..d13C, y=zoox, color=newDepth)) + geom_point()+
scale_color_gradient(limits=c(0, 10), low="gray80", high="darkcyan") +
  ylab(expression(paste("symbionts", ~(cells~cm^-2), sep=""))) +
  xlab(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))) +
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="Depth (m)")
  
p2<-ggplot(df.fig, aes(x=host..d13C, y=zoox, color=Light)) + geom_point()+
  scale_color_gradient(limits=c(0, 25), low="gray80", high="orange") +
  xlab(expression(paste(delta^{13}, C[H], " (\u2030, V-PDB)"))) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank())+
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="DLI")
  
grid.arrange(p1, p2, ncol = 2)


######################
#### zoox versus d13C-S

p3<-ggplot(df.fig, aes(x=symb..d13C, y=zoox, color=newDepth)) + geom_point()+
scale_color_gradient(limits=c(0, 10), low="gray80", high="darkcyan") +
  ylab(expression(paste("symbionts", ~(cells~cm^-2), sep=""))) +
  xlab(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))) +
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="Depth (m)")
  
p4<-ggplot(df.fig, aes(x=symb..d13C, y=zoox, color=Light)) + geom_point()+
  scale_color_gradient(limits=c(0, 25), low="gray80", high="orange") +
  xlab(expression(paste(delta^{13}, C[S], " (\u2030, V-PDB)"))) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank()) +
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="DLI")
  
grid.arrange(p3, p4, ncol = 2)


######################
#### zoox versus d13C-HS

p5<-ggplot(df.fig, aes(x=d13C..host.sym, y=zoox, color=newDepth)) + geom_point()+
scale_color_gradient(limits=c(0, 10), low="gray80", high="darkcyan") +
  ylab(expression(paste("symbionts", ~(cells~cm^-2), sep=""))) +
  xlab(expression(paste(delta^{13}, C[H-S], " (\u2030, V-PDB)"))) +
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="Depth (m)")
  
p6<-ggplot(df.fig, aes(x=d13C..host.sym, y=zoox, color=Light)) + geom_point()+
  scale_color_gradient(limits=c(0, 25), low="gray80", high="orange") +
  xlab(expression(paste(delta^{13}, C[H-S], " (\u2030, V-PDB)"))) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank())+
  guides(color = guide_colourbar(barwidth = 0.8, barheight = 8)) + labs(color="DLI")
  
grid.arrange(p5, p6, ncol = 2)

G<-arrangeGrob(p1,p2,p3,p4,p5,p6, ncol=2)
ggsave(file="figures/regressions/gradient.plots.png", G, height=8, width=8.5)
```